{% extends 'base.html' %}
{% load static %}

{% block title %}Transactions - Budget Tracker{% endblock %}

{% block navbar_title %}Transactions{% endblock %}

{% block body_attributes %}data-selected-category="{{ selected_category }}" data-selected-subcategory="{{ selected_subcategory }}" id="page-body"{% endblock %}

{% block extra_css %}
<style>
    /* Custom checkbox styling */
    .custom-checkbox {
        position: relative;
        min-width: 24px;
        height: 24px;
    }
    
    .custom-checkbox input[type="checkbox"] {
        opacity: 0;
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 2;
        cursor: pointer;
    }
    
    .custom-checkbox-label {
        position: absolute;
        top: 0;
        left: 0;
        width: 24px;
        height: 24px;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    
    .custom-checkbox input[type="checkbox"]:checked + .custom-checkbox-label {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .custom-checkbox input[type="checkbox"]:checked + .custom-checkbox-label::after {
        content: '';
        position: absolute;
        top: 5px;
        left: 8px;
        width: 6px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }
    
    .custom-checkbox input[type="checkbox"]:focus + .custom-checkbox-label {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Improve transaction list item */
    .transaction-item {
        transition: background-color 0.2s ease;
    }
    
    .transaction-item:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
    
    .icon-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
    }
    
    /* Animation for updated balance */
    @keyframes balanceUpdate {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .balance-updated {
        animation: balanceUpdate 0.5s ease;
    }
    
    /* Loading overlay */
    #transactions-loading-overlay {
        transition: opacity 0.3s ease;
    }
    
    /* Fix modal display issues */
    .modal {
        z-index: 1050;
    }
    
    .modal-backdrop {
        z-index: 1040;
    }
    
    .modal-open {
        overflow: hidden;
    }
    
    .modal-open .modal {
        overflow-x: hidden;
        overflow-y: auto;
    }
    
    /* Ensure modals are properly displayed */
    #transactionModal, #deleteModal {
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    /* Fix the issue with screen going black */
    body.modal-open {
        padding-right: 0 !important;
    }
    
    /* Ensure content is visible */
    .modal-content {
        background-color: #fff;
        z-index: 1051;
    }
    
    /* Emergency fix button for modal issues */
    #emergency-fix {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
        padding: 10px 15px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        display: none; /* Hidden by default */
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Show the button when body has modal-open class for more than 10 seconds */
    body.modal-open #emergency-fix {
        display: block;
    }
    
    /* Hide the emergency button when it's not needed */
    body:not(.modal-open) #emergency-fix {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<header class="page-header mb-4 d-flex justify-content-between align-items-center">
    <h1 class="h2">Transactions</h1>
    <div class="actions">
        <!-- Test button for delete modal - Commented out -->
        <!--
        <button type="button" class="btn btn-outline-primary me-2" id="test-delete-modal">
            <i class="bi bi-bug"></i> Test Delete Modal
        </button>
        -->
        
        <button type="button" class="btn btn-success" id="add-income-btn">
            <i class="bi bi-plus-circle"></i> Add Income
        </button>
        <button type="button" class="btn btn-danger" id="add-expense-btn">
            <i class="bi bi-dash-circle"></i> Add Expense
        </button>
    </div>
</header>

<div class="row">
    <!-- Filter Container -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Filter</h2>
            </div>
            <div class="card-body">
                <form id="transaction-filter-form">
                    <div class="mb-3">
                        <label for="category-filter" class="form-label">Category</label>
                        <select id="category-filter" class="form-select">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" data-icon="{{ category.icon }}" data-type="{{ category.type }}" data-is-category="true">{{ category.name }}</option>
                                {% for subcategory in category.subcategories.all %}
                                <option value="{{ category.id }}" data-icon="{{ subcategory.icon|default:category.icon }}" data-type="{{ category.type }}" data-parent-category="{{ category.id }}" data-subcategory-id="{{ subcategory.id }}">{{ subcategory.name }}</option>
                                {% endfor %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="from-to-filter" class="form-label">Title or Notes</label>
                        <input type="text" id="from-to-filter" class="form-control" placeholder="Search by title or notes">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label d-block">Type</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="expense-check" value="expense" checked>
                            <label class="form-check-label" for="expense-check">Expenses</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="income-check" value="income" checked>
                            <label class="form-check-label" for="income-check">Income</label>
                        </div>
                    </div>
                    
                    <button type="button" id="apply-filters-btn" class="btn btn-primary w-100">Apply Filters</button>
                    <button type="button" id="clear-filters-btn" class="btn btn-outline-secondary w-100 mt-2">Clear Filters</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Transactions List -->
    <div class="col-md-9">
        <div class="card border-0 shadow-sm mb-4">
            <!-- Month Navigation -->
            <div class="card-header d-flex justify-content-between align-items-center">
                <button type="button" id="prev-month-btn" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <div>
                    <h3 id="current-month" class="h5 mb-0">{{ current_month_name }} {{ current_year }}</h3>
                    <div id="current-month-data" data-month="{{ current_month }}" data-year="{{ current_year }}" class="d-none"></div>
                </div>
                <button type="button" id="next-month-btn" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            
            <!-- Transactions Summary -->
            <div class="card-body pb-0">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-bold">Transactions: </span>
                        <span id="transaction-count">{{ transactions.count }}</span>
                    </div>
                    <div>
                        <span class="fw-bold">Total: </span>
                        <span id="transaction-total" class="{% if total_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ total_balance|floatformat:2 }}
                        </span>
                    </div>
                </div>
                <!-- Add select all option -->
                <div class="mt-3 d-flex justify-content-between align-items-center border-bottom pb-2">
                    <div class="d-flex align-items-center">
                        <div class="custom-checkbox me-2" style="min-width: 24px;">
                            <input class="select-all-transactions" type="checkbox" id="select-all-transactions">
                            <label class="custom-checkbox-label" for="select-all-transactions"></label>
                        </div>
                        <label class="form-check-label ms-1" for="select-all-transactions">
                            Select All
                        </label>
                    </div>
                    <div class="batch-actions invisible">
                        <button class="btn btn-sm btn-danger batch-delete" type="button">
                            Delete Selected (<span class="selected-count">0</span>)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Transactions List -->
            <div class="list-group list-group-flush">
                {% if transactions %}
                    {% for transaction in transactions %}
                    <div class="list-group-item d-flex justify-content-between align-items-center transaction-item position-relative">
                        <div class="d-flex align-items-center">
                            <div class="custom-checkbox me-2">
                                <input class="transaction-check" type="checkbox" value="{{ transaction.id }}" id="check-{{ transaction.id }}">
                                <label class="custom-checkbox-label" for="check-{{ transaction.id }}"></label>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="transaction-icon me-3">
                                    <span class="icon-wrapper rounded-circle bg-{% if transaction.type == 'income' %}success{% else %}danger{% endif %} p-2">
                                        <i class="{% if transaction.subcategory %}{{ transaction.subcategory.icon }}{% elif transaction.category %}{{ transaction.category.icon }}{% else %}bi bi-tag{% endif %} text-white"></i>
                                    </span>
                                </div>
                                <div>
                                    <div class="fw-bold">{{ transaction.title }}</div>
                                    <small class="text-muted">
                                        {% if transaction.subcategory %}{{ transaction.subcategory.name }}{% elif transaction.category %}{{ transaction.category.name }}{% else %}Uncategorized{% endif %}
                                        {% if transaction.notes %}- {{ transaction.notes }}{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="text-end me-3">
                                <div class="{% if transaction.type == 'income' %}text-success{% else %}text-danger{% endif %} fw-bold">
                                    {% if transaction.type == 'income' %}+{% else %}-{% endif %}${{ transaction.amount|floatformat:2 }}
                                </div>
                                <small class="text-muted">{{ transaction.date|date:"m/d/Y" }}</small>
                            </div>
                            <!-- Transaction Actions -->
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="dropdownMenuButton-{{ transaction.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton-{{ transaction.id }}">
                                    <li><a class="dropdown-item edit-transaction" href="#" data-id="{{ transaction.id }}">Edit</a></li>
                                    <li><a class="dropdown-item duplicate-transaction" href="#" data-id="{{ transaction.id }}">Duplicate</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item delete-transaction text-danger" href="#" data-id="{{ transaction.id }}">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                        <!-- Color indicator bar -->
                        <div class="position-absolute top-0 bottom-0 end-0 transaction-indicator {% if transaction.type == 'income' %}bg-success{% else %}bg-danger{% endif %}" style="width: 4px;"></div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="list-group-item py-4 text-center">
                        <p class="mb-0">No transactions found for this period</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Transaction Modal (for Add/Edit) -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="transaction-form">
                    {% csrf_token %}
                    <input type="hidden" id="transaction-id" name="transaction_id" value="">
                    <input type="hidden" id="transaction-type" name="type" value="expense">
                    
                    <div class="mb-3">
                        <label for="transaction-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="transaction-title" name="title" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="transaction-amount" class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text" id="currency-symbol">â‚±</span>
                                <input type="number" class="form-control" id="transaction-amount" name="amount" step="0.01" min="0.01" placeholder="0.00" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="transaction-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="transaction-date" name="date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="transaction-time" class="form-label">Time</label>
                            <input type="time" class="form-control" id="transaction-time" name="time" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-account" class="form-label">Account</label>
                        <div class="input-group">
                            <select class="form-select account-select w-100" id="transaction-account" name="transaction_account" style="height: 46px;">
                                <option value="" data-icon="bi-bank">Choose your account</option>
                                {% for account in accounts %}
                                <option value="{{ account.id }}" data-account-type="{{ account.get_account_type }}" 
                                        data-icon="{% if account.get_account_type == 'credit' %}bi-credit-card{% elif account.get_account_type == 'wallet' %}bi-wallet2{% else %}bi-piggy-bank{% endif %}">
                                    {{ account.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-category" class="form-label">Category</label>
                        <div class="input-group">
                            <select class="form-select category-select w-100" id="transaction-category" name="category" style="height: 46px;">
                                <option value="" data-icon="bi-bookmark">Choose a category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" data-icon="{{ category.icon }}" data-type="{{ category.type }}" data-is-category="true">{{ category.name }}</option>
                                    {% for subcategory in category.subcategories.all %}
                                    <option value="{{ category.id }}" data-icon="{{ subcategory.icon|default:category.icon }}" data-type="{{ category.type }}" data-parent-category="{{ category.id }}" data-subcategory-id="{{ subcategory.id }}">{{ subcategory.name }}</option>
                                    {% endfor %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" id="transaction-subcategory" name="subcategory" value="">
                    
                    <div class="mb-3">
                        <label for="transaction-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="transaction-notes" name="notes" rows="2" placeholder="Add notes about this transaction"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-transaction-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="delete-confirmation-message">Are you sure you want to delete this transaction? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Emergency fix button for modal issues - Commented out -->
<!--
<button id="emergency-fix" type="button" onclick="fixModalIssues()">
    Screen stuck? Click to fix!
</button>
-->
{% endblock %}

{% block extra_scripts %}
<!-- Ensure Bootstrap JS is properly loaded -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Other scripts -->
<script src="{% static 'js/category_dropdown.js' %}"></script>
<script src="{% static 'js/transaction.js' %}"></script>
<script src="{% static 'js/filter_category_dropdown.js' %}"></script>
<script src="{% static 'js/transaction_list.js' %}"></script>
<!-- Modal initialization script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Checking bootstrap availability:', typeof bootstrap !== 'undefined');
        console.log('Checking bootstrap.Modal availability:', 
                  typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined');
        console.log('DeleteModal element exists:', document.getElementById('deleteModal') !== null);
        
        // Advanced modal management to prevent black screen issues
        function setupModalManagement() {
            // Get all modals on the page
            const modals = document.querySelectorAll('.modal');
            
            // For each modal, ensure it has proper event listeners
            modals.forEach(modal => {
                // Click outside modal to close
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        console.log('Clicked outside modal content, closing modal');
                        closeModalProperly(modal);
                    }
                });
                
                // Close button click handler
                const closeButtons = modal.querySelectorAll('[data-bs-dismiss="modal"], .btn-close, .btn-secondary');
                closeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        console.log('Modal close button clicked');
                        closeModalProperly(modal);
                    });
                });
            });
            
            // Escape key to close any visible modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' || e.keyCode === 27) {
                    const visibleModal = document.querySelector('.modal.show');
                    if (visibleModal) {
                        console.log('Escape key pressed, closing modal');
                        closeModalProperly(visibleModal);
                    }
                }
            });
            
            // Click on backdrop to close modal
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-backdrop')) {
                    console.log('Backdrop clicked, closing modals');
                    document.querySelectorAll('.modal.show').forEach(modal => {
                        closeModalProperly(modal);
                    });
                }
            });
            
            // Function to properly close a modal
            function closeModalProperly(modal) {
                // Try bootstrap first
                try {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const bsModal = bootstrap.Modal.getInstance(modal);
                        if (bsModal) {
                            bsModal.hide();
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('Error using Bootstrap to close modal:', err);
                }
                
                // Fallback to manual closing
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                
                // Remove backdrop manually
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                
                // Reset body
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }
            
            // Detect when a modal backdrop is added to the DOM
            const bodyObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.classList && node.classList.contains('modal-backdrop')) {
                                console.log('Modal backdrop detected');
                                // Check if any modal is actually visible
                                setTimeout(function() {
                                    const visibleModals = document.querySelectorAll('.modal.show');
                                    if (visibleModals.length === 0) {
                                        console.log('No visible modals, removing orphaned backdrop');
                                        node.remove();
                                        document.body.classList.remove('modal-open');
                                        document.body.style.overflow = '';
                                        document.body.style.paddingRight = '';
                                    }
                                }, 100);
                            }
                        });
                    }
                });
            });
            
            // Start observing the body for added modal backdrops
            bodyObserver.observe(document.body, {
                childList: true,
                subtree: false
            });
        }
        
        // Run modal setup
        setupModalManagement();
        
        // Function to clean up any stray modal elements
        function cleanupModalArtifacts() {
            // Remove any stuck modal backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            if (backdrops.length > 0) {
                console.log('Cleaning up', backdrops.length, 'modal backdrops');
                backdrops.forEach(backdrop => backdrop.remove());
            }
            
            // Ensure body doesn't have modal-open class if no modals are visible
            const visibleModals = document.querySelectorAll('.modal.show');
            if (visibleModals.length === 0 && document.body.classList.contains('modal-open')) {
                console.log('Removing modal-open class from body');
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }
        }
        
        // Run cleanup on page load
        cleanupModalArtifacts();
        
        // Override loadTransactionsForMonth to clean up after refresh
        if (typeof window.loadTransactionsForMonth === 'function') {
            const originalLoadTransactions = window.loadTransactionsForMonth;
            window.loadTransactionsForMonth = function(...args) {
                // Clean up before loading new transactions
                cleanupModalArtifacts();
                
                // Call the original function
                const result = originalLoadTransactions.apply(this, args);
                
                // Clean up after a short delay to ensure any new modals are properly handled
                setTimeout(() => {
                    cleanupModalArtifacts();
                    
                    // After cleaning up, reattach event handlers
                    if (typeof window.attachDeleteEventHandlers === 'function') {
                        window.attachDeleteEventHandlers();
                    }
                }, 200);
                
                return result;
            };
        }
        
        // Initialize all dropdowns
        function initializeDropdowns() {
            console.log('Initializing dropdowns');
            
            // First, try to initialize using Bootstrap's Dropdown
            document.querySelectorAll('.dropdown-toggle').forEach(function(dropdownToggle) {
                try {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
                        new bootstrap.Dropdown(dropdownToggle);
                    }
                } catch (err) {
                    console.error('Error initializing dropdown:', err);
                }
                
                // Also add a direct click handler as a fallback
                dropdownToggle.removeEventListener('click', toggleDropdownMenu);
                dropdownToggle.addEventListener('click', toggleDropdownMenu);
            });
        }
        
        // Function to manually toggle dropdown menu visibility
        function toggleDropdownMenu(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropdownMenu = this.nextElementSibling;
            if (!dropdownMenu || !dropdownMenu.classList.contains('dropdown-menu')) {
                return;
            }
            
            // Toggle dropdown visibility
            const isCurrentlyVisible = dropdownMenu.classList.contains('show');
            
            // First close all other open dropdowns
            document.querySelectorAll('.dropdown-menu.show').forEach(function(menu) {
                if (menu !== dropdownMenu) {
                    menu.classList.remove('show');
                }
            });
            
            // Toggle this dropdown
            if (isCurrentlyVisible) {
                dropdownMenu.classList.remove('show');
            } else {
                dropdownMenu.classList.add('show');
                dropdownMenu.style.position = 'absolute';
                dropdownMenu.style.inset = '0px 0px auto auto';
                dropdownMenu.style.margin = '0px';
                dropdownMenu.style.transform = 'translate(-8px, 40px)';
            }
            
            // Close dropdown when clicking outside
            if (!isCurrentlyVisible) {
                const closeDropdownHandler = function(evt) {
                    if (!dropdownMenu.contains(evt.target) && evt.target !== e.target) {
                        dropdownMenu.classList.remove('show');
                        document.removeEventListener('click', closeDropdownHandler);
                    }
                };
                
                // Add event listener with a small delay to avoid immediate triggering
                setTimeout(function() {
                    document.addEventListener('click', closeDropdownHandler);
                }, 10);
            }
        }
        
        // Run initial dropdown initialization
        initializeDropdowns();
        
        // Execute initialization after transaction list is updated
        const transactionListElement = document.querySelector('.list-group-flush');
        if (transactionListElement) {
            const observer = new MutationObserver(function(mutations) {
                console.log('Transaction list changed, initializing dropdowns');
                initializeDropdowns();
            });
            
            observer.observe(transactionListElement, { childList: true });
        }
        
        // Override updateTransactionList function if it gets defined later
        const originalUpdateTransactionList = window.updateTransactionList;
        if (originalUpdateTransactionList) {
            window.updateTransactionList = function(...args) {
                const result = originalUpdateTransactionList.apply(this, args);
                setTimeout(initializeDropdowns, 10);
                return result;
            };
        }
        
        // Global function to show the delete modal directly
        window.showDeleteConfirmationModal = function(title, message, confirmText, confirmCallback) {
            const deleteModal = document.getElementById('deleteModal');
            const deleteModalLabel = document.getElementById('deleteModalLabel');
            const deleteConfirmationMessage = document.getElementById('delete-confirmation-message');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            
            if (!deleteModal || !deleteModalLabel || !deleteConfirmationMessage || !confirmDeleteBtn) {
                console.error('Delete modal elements not found');
                alert('Error showing confirmation dialog');
                return;
            }
            
            // Clean up any existing backdrops before showing a new modal
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            
            // Update modal content
            deleteModalLabel.textContent = title || 'Confirm Delete';
            deleteConfirmationMessage.innerHTML = message || 'Are you sure you want to delete this item?';
            confirmDeleteBtn.textContent = confirmText || 'Delete';
            confirmDeleteBtn.classList.remove('btn-primary');
            confirmDeleteBtn.classList.add('btn-danger');
            
            // Show the modal using Bootstrap if available, otherwise fallback to direct DOM manipulation
            try {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const bsModal = new bootstrap.Modal(deleteModal);
                    bsModal.show();
                    
                    // Set the confirm button handler
                    confirmDeleteBtn.onclick = function() {
                        if (typeof confirmCallback === 'function') {
                            confirmCallback();
                        }
                        bsModal.hide();
                    };
                    
                    // Set event handler to clean up when the modal is hidden
                    deleteModal.addEventListener('hidden.bs.modal', function() {
                        cleanupModalState();
                    }, { once: true });
                    
                    return;
                }
            } catch (err) {
                console.error('Error using Bootstrap Modal:', err);
                // Continue with fallback
            }
            
            // Fallback to direct DOM manipulation if Bootstrap failed
            console.log('Using direct DOM manipulation for modal');
            
            // Show the modal using direct DOM API
            deleteModal.classList.add('show');
            deleteModal.style.display = 'block';
            document.body.classList.add('modal-open');
            
            // Create backdrop manually
            const backdrop = document.createElement('div');
            backdrop.classList.add('modal-backdrop', 'show');
            document.body.appendChild(backdrop);
            
            // Set the confirm button handler
            confirmDeleteBtn.onclick = function() {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                
                // Hide the modal
                hideDeleteConfirmationModal();
            };
            
            // Set cancel button handler
            const cancelBtn = deleteModal.querySelector('.btn-secondary');
            if (cancelBtn) {
                cancelBtn.onclick = hideDeleteConfirmationModal;
            }
            
            // Also capture click on X button
            const closeBtn = deleteModal.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.onclick = hideDeleteConfirmationModal;
            }
            
            // Also capture click outside modal
            deleteModal.onclick = function(event) {
                if (event.target === deleteModal) {
                    hideDeleteConfirmationModal();
                }
            };
            
            // Escape key handler
            const escHandler = function(e) {
                if (e.key === 'Escape' || e.keyCode === 27) {
                    hideDeleteConfirmationModal();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            function hideDeleteConfirmationModal() {
                // Hide the modal
                deleteModal.classList.remove('show');
                deleteModal.style.display = 'none';
                
                // Remove the backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                
                // Reset body state
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // Clean up event handlers
                cleanupModalState();
            }
            
            function cleanupModalState() {
                // Reset the modal content and events
                if (cancelBtn) cancelBtn.onclick = null;
                if (closeBtn) closeBtn.onclick = null;
                deleteModal.onclick = null;
                confirmDeleteBtn.onclick = null;
                
                // Remove the escape key handler
                document.removeEventListener('keydown', escHandler);
            }
        };
        
        // Function to attach delete event handlers to transaction items
        window.attachDeleteEventHandlers = function() {
            console.log('Attaching delete event handlers to transaction items');
            
            // Direct event listeners for delete transaction links
            document.querySelectorAll('.delete-transaction').forEach(link => {
                // Remove existing listener first to prevent duplicates
                link.removeEventListener('click', handleDeleteClick);
                // Add the new listener
                link.addEventListener('click', handleDeleteClick);
            });
            
            // Direct event listener for batch delete button
            const batchDeleteBtn = document.querySelector('.batch-delete');
            if (batchDeleteBtn) {
                // Remove existing listener first
                batchDeleteBtn.removeEventListener('click', handleBatchDeleteClick);
                // Add the new listener
                batchDeleteBtn.addEventListener('click', handleBatchDeleteClick);
            }
        };
        
        // Handler function for delete transaction clicks
        function handleDeleteClick(e) {
            e.preventDefault();
            const transactionId = this.getAttribute('data-id');
            
            // Find the transaction title
            const transactionItem = this.closest('.transaction-item');
            const transactionTitle = transactionItem ? transactionItem.querySelector('.fw-bold').textContent : 'this transaction';
            
            // Show confirmation dialog
            window.showDeleteConfirmationModal(
                'Confirm Delete Transaction',
                `<p>Are you sure you want to delete the transaction <strong>"${transactionTitle}"</strong>?</p>
                 <div class="alert alert-warning">
                     <i class="bi bi-exclamation-triangle-fill me-2"></i>
                     This action cannot be undone.
                 </div>`,
                'Delete Transaction',
                function() {
                    // Send delete request
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    fetch(`/finances/transactions/api/${transactionId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Reset selection counter and hide batch actions
                            document.querySelector('.selected-count').textContent = '0';
                            document.querySelector('.batch-actions').classList.add('invisible');
                            document.getElementById('select-all-transactions').checked = false;
                            
                            // Reload transactions
                            const urlParams = new URLSearchParams(window.location.search);
                            if (typeof loadTransactionsForMonth === 'function') {
                                loadTransactionsForMonth(urlParams.toString());
                            } else {
                                // Fallback to page reload
                                window.location.reload();
                            }
                            
                            if (typeof showToast === 'function') {
                                showToast('Success', 'Transaction deleted successfully', 'success');
                            }
                        } else {
                            throw new Error(data.error || 'Unknown error');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting transaction:', error);
                        if (typeof showToast === 'function') {
                            showToast('Error', 'Failed to delete transaction: ' + error.message, 'danger');
                        } else {
                            alert('Error deleting transaction: ' + error.message);
                        }
                    });
                }
            );
        }
        
        // Handler function for batch delete clicks
        function handleBatchDeleteClick() {
            const checkedBoxes = document.querySelectorAll('.transaction-check:checked');
            if (checkedBoxes.length === 0) return;
            
            const transactionIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
            const count = transactionIds.length;
            
            // Show confirmation dialog
            window.showDeleteConfirmationModal(
                'Confirm Batch Delete',
                `<p>Are you sure you want to delete ${count} selected transaction(s)?</p>
                 <div class="alert alert-warning">
                     <i class="bi bi-exclamation-triangle-fill me-2"></i>
                     This action cannot be undone.
                 </div>`,
                'Delete Selected Transactions',
                function() {
                    // Send batch delete request
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    fetch('/finances/transactions/api/batch-delete/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ transaction_ids: transactionIds })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Reset selection counter and hide batch actions
                            document.querySelector('.selected-count').textContent = '0';
                            document.querySelector('.batch-actions').classList.add('invisible');
                            document.getElementById('select-all-transactions').checked = false;
                            
                            // Reload transactions
                            const urlParams = new URLSearchParams(window.location.search);
                            if (typeof loadTransactionsForMonth === 'function') {
                                loadTransactionsForMonth(urlParams.toString());
                            } else {
                                // Fallback to page reload
                                window.location.reload();
                            }
                            
                            if (typeof showToast === 'function') {
                                showToast('Success', `Successfully deleted ${count} transaction(s)`, 'success');
                            }
                        } else {
                            throw new Error(data.error || 'Unknown error');
                        }
                    })
                    .catch(error => {
                        console.error('Error batch deleting transactions:', error);
                        if (typeof showToast === 'function') {
                            showToast('Error', 'Failed to delete transactions: ' + error.message, 'danger');
                        } else {
                            alert('Error deleting transactions: ' + error.message);
                        }
                    });
                }
            );
        }
        
        // If test button exists, add a direct handler - Commented out
        /*
        const testBtn = document.getElementById('test-delete-modal');
        if (testBtn) {
            testBtn.addEventListener('click', function() {
                window.showDeleteConfirmationModal(
                    'Test Delete Modal',
                    '<p>This is a test of the delete modal functionality.</p>' +
                    '<div class="alert alert-warning">' +
                    '<i class="bi bi-exclamation-triangle-fill me-2"></i>' +
                    'This is just a test, no action will be taken.' +
                    '</div>',
                    'Test Button',
                    function() {
                        alert('Test button clicked!');
                    }
                );
            });
        }
        */
        
        // Initial attachment of event handlers
        window.attachDeleteEventHandlers();
        
        // Add a mutation observer to watch for changes to the transaction list
        // This ensures event handlers are reattached when the transaction list is updated
        const transactionListForHandlers = document.querySelector('.list-group-flush');
        if (transactionListForHandlers) {
            const observer = new MutationObserver(function(mutations) {
                window.attachDeleteEventHandlers();
            });
            
            observer.observe(transactionListForHandlers, { childList: true, subtree: true });
        }
        
        // Add emergency fix function - Commented out
        /*
        window.fixModalIssues = function() {
            console.log('Emergency fix executed');
            
            // Remove all modal backdrops
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            
            // Hide all modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
                modal.classList.remove('show');
                modal.setAttribute('aria-hidden', 'true');
            });
            
            // Reset body styles
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            return false; // Prevent default
        };
        
        // Add keyboard shortcut (Escape key) to fix modal issues
        document.addEventListener('keydown', function(e) {
            // ESC key
            if (e.key === 'Escape' || e.keyCode === 27) {
                // Only execute if body has modal-open class
                if (document.body.classList.contains('modal-open')) {
                    window.fixModalIssues();
                }
            }
        });
        */
    });
</script>
{% endblock %} 