{% extends 'base.html' %}
{% load static %}

{% block title %}Transactions - Budget Tracker{% endblock %}

{% block content %}
<header class="page-header mb-4 d-flex justify-content-between align-items-center">
    <h1 class="h2">Transactions</h1>
    <div class="actions">
        <button type="button" class="btn btn-success" id="add-income-btn">
            <i class="bi bi-plus-circle"></i> Add Income
        </button>
        <button type="button" class="btn btn-danger" id="add-expense-btn">
            <i class="bi bi-dash-circle"></i> Add Expense
        </button>
    </div>
</header>

<div class="row">
    <!-- Filter Container -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Filter</h2>
            </div>
            <div class="card-body">
                <form id="transaction-filter-form">
                    <div class="mb-3">
                        <label for="category-filter" class="form-label">Category</label>
                        <select id="category-filter" class="form-select">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="from-to-filter" class="form-label">From/To</label>
                        <input type="text" id="from-to-filter" class="form-control" placeholder="Search by title or notes">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label d-block">Type</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="expense-check" value="expense" checked>
                            <label class="form-check-label" for="expense-check">Expenses</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="income-check" value="income" checked>
                            <label class="form-check-label" for="income-check">Income</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="transfer-check" value="transfer">
                            <label class="form-check-label" for="transfer-check">Transfer between accounts</label>
                        </div>
                    </div>
                    
                    <button type="button" id="apply-filters-btn" class="btn btn-primary w-100">Apply Filters</button>
                    <button type="button" id="clear-filters-btn" class="btn btn-outline-secondary w-100 mt-2">Clear Filters</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Transactions List -->
    <div class="col-md-9">
        <div class="card border-0 shadow-sm mb-4">
            <!-- Month Navigation -->
            <div class="card-header d-flex justify-content-between align-items-center">
                <button type="button" id="prev-month-btn" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <h3 id="current-month" class="h5 mb-0">{{ current_month_name }} {{ current_year }}</h3>
                <button type="button" id="next-month-btn" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            
            <!-- Transactions Summary -->
            <div class="card-body pb-0">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-bold">Transactions: </span>
                        <span id="transaction-count">{{ transactions.count }}</span>
                    </div>
                    <div>
                        <span class="fw-bold">Total: </span>
                        <span id="transaction-total" class="{% if total_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ total_balance|floatformat:2 }}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Transactions List -->
            <div class="list-group list-group-flush">
                {% if transactions %}
                    {% for transaction in transactions %}
                    <div class="list-group-item d-flex justify-content-between align-items-center transaction-item position-relative">
                        <div class="form-check">
                            <input class="form-check-input transaction-check" type="checkbox" value="{{ transaction.id }}" id="check-{{ transaction.id }}">
                            <label class="form-check-label" for="check-{{ transaction.id }}">
                                <div class="d-flex align-items-center">
                                    <div class="transaction-icon me-3">
                                        {% if transaction.category %}
                                        <span class="icon-wrapper rounded-circle bg-{% if transaction.type == 'income' %}success{% else %}danger{% endif %} p-2">
                                            <i class="{{ transaction.category.icon }} text-white"></i>
                                        </span>
                                        {% else %}
                                        <span class="icon-wrapper rounded-circle bg-secondary p-2">
                                            <i class="bi bi-question-circle text-white"></i>
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ transaction.title }}</div>
                                        <small class="text-muted">
                                            {% if transaction.category %}{{ transaction.category.name }}{% else %}Uncategorized{% endif %}
                                            {% if transaction.notes %}- {{ transaction.notes }}{% endif %}
                                        </small>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="text-end me-3">
                                <div class="{% if transaction.type == 'income' %}text-success{% else %}text-danger{% endif %} fw-bold">
                                    {% if transaction.type == 'income' %}+{% else %}-{% endif %}${{ transaction.amount|floatformat:2 }}
                                </div>
                                <small class="text-muted">{{ transaction.date|date:"m/d/Y" }}</small>
                            </div>
                            <!-- Transaction Actions -->
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item edit-transaction" href="#" data-id="{{ transaction.id }}">Edit</a></li>
                                    <li><a class="dropdown-item duplicate-transaction" href="#" data-id="{{ transaction.id }}">Duplicate</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item delete-transaction text-danger" href="#" data-id="{{ transaction.id }}">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                        <!-- Color indicator bar -->
                        <div class="position-absolute top-0 bottom-0 end-0 transaction-indicator {% if transaction.type == 'income' %}bg-success{% else %}bg-danger{% endif %}" style="width: 4px;"></div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="list-group-item py-4 text-center">
                        <p class="mb-0">No transactions found for this period</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Transaction Modal (for Add/Edit) -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="transaction-form">
                    {% csrf_token %}
                    <input type="hidden" id="transaction-id" name="transaction_id" value="">
                    <input type="hidden" id="transaction-type" name="type" value="expense">
                    
                    <div class="mb-3">
                        <label for="transaction-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="transaction-title" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-amount" class="form-label">Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="transaction-amount" name="amount" step="0.01" min="0.01" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="transaction-date" name="date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-category" class="form-label">Category</label>
                        <select class="form-select" id="transaction-category" name="category">
                            <option value="">-- Select Category --</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-subcategory" class="form-label">Subcategory</label>
                        <select class="form-select" id="transaction-subcategory" name="subcategory" disabled>
                            <option value="">-- Select Subcategory --</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-payment-method" class="form-label">Payment Method</label>
                        <select class="form-select" id="transaction-payment-method" name="payment_method">
                            <option value="cash">Cash</option>
                            <option value="credit_card">Credit Card</option>
                            <option value="debit_card">Debit Card</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="mobile_payment">Mobile Payment</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="transaction-notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-transaction-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this transaction? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Current selected month/year (initialize with displayed values)
        let currentMonth = {% if current_month %}{{ current_month }}{% else %}new Date().getMonth() + 1{% endif %};
        let currentYear = {% if current_year %}{{ current_year }}{% else %}new Date().getFullYear(){% endif %};
        let deleteTransactionId = null;
        
        // Month navigation
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const currentMonthDisplay = document.getElementById('current-month');
        
        // Filter elements
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        
        // Transaction buttons
        const addIncomeBtn = document.getElementById('add-income-btn');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const saveTransactionBtn = document.getElementById('save-transaction-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        // Add event listeners for month navigation
        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            loadTransactionsForMonth();
        });
        
        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            loadTransactionsForMonth();
        });
        
        // Apply filters event
        applyFiltersBtn.addEventListener('click', () => {
            loadTransactionsForMonth();
        });
        
        // Clear filters event
        clearFiltersBtn.addEventListener('click', () => {
            document.getElementById('category-filter').value = '';
            document.getElementById('from-to-filter').value = '';
            document.getElementById('expense-check').checked = true;
            document.getElementById('income-check').checked = true;
            document.getElementById('transfer-check').checked = false;
            loadTransactionsForMonth();
        });
        
        // Add transaction buttons
        addIncomeBtn.addEventListener('click', () => {
            openTransactionModal('income');
        });
        
        addExpenseBtn.addEventListener('click', () => {
            openTransactionModal('expense');
        });
        
        // Save transaction
        saveTransactionBtn.addEventListener('click', saveTransaction);
        
        // Delete transaction
        confirmDeleteBtn.addEventListener('click', () => {
            if (deleteTransactionId) {
                deleteTransaction(deleteTransactionId);
            }
        });
        
        // Delegate event listeners for transaction actions (edit, duplicate, delete)
        document.addEventListener('click', function(e) {
            // Edit transaction
            if (e.target.classList.contains('edit-transaction') || e.target.parentElement.classList.contains('edit-transaction')) {
                e.preventDefault();
                const element = e.target.classList.contains('edit-transaction') ? e.target : e.target.parentElement;
                const transactionId = element.dataset.id;
                editTransaction(transactionId);
            }
            
            // Duplicate transaction
            if (e.target.classList.contains('duplicate-transaction') || e.target.parentElement.classList.contains('duplicate-transaction')) {
                e.preventDefault();
                const element = e.target.classList.contains('duplicate-transaction') ? e.target : e.target.parentElement;
                const transactionId = element.dataset.id;
                duplicateTransaction(transactionId);
            }
            
            // Delete transaction
            if (e.target.classList.contains('delete-transaction') || e.target.parentElement.classList.contains('delete-transaction')) {
                e.preventDefault();
                const element = e.target.classList.contains('delete-transaction') ? e.target : e.target.parentElement;
                const transactionId = element.dataset.id;
                deleteTransactionId = transactionId;
                
                // Show delete confirmation modal
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            }
        });
        
        // Handle category change for subcategories
        document.getElementById('transaction-category').addEventListener('change', function() {
            loadSubcategories(this.value);
        });
        
        // Functions
        function loadTransactionsForMonth() {
            // Format the month name to display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            currentMonthDisplay.textContent = `${monthNames[currentMonth-1]} ${currentYear}`;
            
            // Get filter values
            const categoryId = document.getElementById('category-filter').value;
            const searchTerm = document.getElementById('from-to-filter').value;
            const includeExpenses = document.getElementById('expense-check').checked;
            const includeIncome = document.getElementById('income-check').checked;
            const includeTransfers = document.getElementById('transfer-check').checked;
            
            // Build transaction types array
            const types = [];
            if (includeExpenses) types.push('expense');
            if (includeIncome) types.push('income');
            // Note: Transfer is not implemented in current model, but we include for future
            
            // AJAX call to get filtered transactions
            fetch(`/finances/transactions/api/?month=${currentMonth}&year=${currentYear}&category=${categoryId}&search=${searchTerm}&types=${types.join(',')}`)
                .then(response => response.json())
                .then(data => {
                    updateTransactionsList(data.transactions);
                    document.getElementById('transaction-count').textContent = data.count;
                    document.getElementById('transaction-total').textContent = `$${data.total.toFixed(2)}`;
                    
                    // Update class based on total value
                    const totalElement = document.getElementById('transaction-total');
                    if (data.total >= 0) {
                        totalElement.classList.remove('text-danger');
                        totalElement.classList.add('text-success');
                    } else {
                        totalElement.classList.remove('text-success');
                        totalElement.classList.add('text-danger');
                    }
                })
                .catch(error => console.error('Error loading transactions:', error));
        }
        
        function updateTransactionsList(transactions) {
            const listContainer = document.querySelector('.list-group');
            
            if (transactions.length === 0) {
                listContainer.innerHTML = `
                    <div class="list-group-item py-4 text-center">
                        <p class="mb-0">No transactions found for this period</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            transactions.forEach(transaction => {
                html += `
                <div class="list-group-item d-flex justify-content-between align-items-center transaction-item position-relative">
                    <div class="form-check">
                        <input class="form-check-input transaction-check" type="checkbox" value="${transaction.id}" id="check-${transaction.id}">
                        <label class="form-check-label" for="check-${transaction.id}">
                            <div class="d-flex align-items-center">
                                <div class="transaction-icon me-3">
                                    <span class="icon-wrapper rounded-circle bg-${transaction.type === 'income' ? 'success' : 'danger'} p-2">
                                        <i class="${transaction.category_icon || 'bi bi-tag'} text-white"></i>
                                    </span>
                                </div>
                                <div>
                                    <div class="fw-bold">${transaction.title}</div>
                                    <small class="text-muted">
                                        ${transaction.category_name || 'Uncategorized'}
                                        ${transaction.notes ? '- ' + transaction.notes : ''}
                                    </small>
                                </div>
                            </div>
                        </label>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="text-end me-3">
                            <div class="${transaction.type === 'income' ? 'text-success' : 'text-danger'} fw-bold">
                                ${transaction.type === 'income' ? '+' : '-'}$${parseFloat(transaction.amount).toFixed(2)}
                            </div>
                            <small class="text-muted">${formatDate(transaction.date)}</small>
                        </div>
                        <!-- Transaction Actions -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item edit-transaction" href="#" data-id="${transaction.id}">Edit</a></li>
                                <li><a class="dropdown-item duplicate-transaction" href="#" data-id="${transaction.id}">Duplicate</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item delete-transaction text-danger" href="#" data-id="${transaction.id}">Delete</a></li>
                            </ul>
                        </div>
                    </div>
                    <!-- Color indicator bar -->
                    <div class="position-absolute top-0 bottom-0 end-0 transaction-indicator ${transaction.type === 'income' ? 'bg-success' : 'bg-danger'}" style="width: 4px;"></div>
                </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
        }
        
        function openTransactionModal(type) {
            // Reset form
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-id').value = '';
            document.getElementById('transaction-type').value = type;
            
            // Set default date to today
            const today = new Date();
            document.getElementById('transaction-date').value = formatDateForInput(today);
            
            // Update modal title based on transaction type
            const modalTitle = type === 'income' ? 'Add Income' : 'Add Expense';
            document.getElementById('transactionModalLabel').textContent = modalTitle;
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('transactionModal')).show();
        }
        
        function editTransaction(transactionId) {
            // Fetch transaction details
            fetch(`/finances/transactions/api/${transactionId}/`)
                .then(response => response.json())
                .then(transaction => {
                    // Fill form with transaction data
                    document.getElementById('transaction-id').value = transaction.id;
                    document.getElementById('transaction-title').value = transaction.title;
                    document.getElementById('transaction-amount').value = transaction.amount;
                    document.getElementById('transaction-date').value = formatDateForInput(new Date(transaction.date));
                    document.getElementById('transaction-type').value = transaction.type;
                    document.getElementById('transaction-category').value = transaction.category || '';
                    document.getElementById('transaction-notes').value = transaction.notes || '';
                    
                    // Set payment method if available, otherwise default to cash
                    if (transaction.payment_method) {
                        document.getElementById('transaction-payment-method').value = transaction.payment_method;
                    } else {
                        document.getElementById('transaction-payment-method').value = 'cash';
                    }
                    
                    // Load subcategories if category is selected
                    if (transaction.category) {
                        loadSubcategories(transaction.category, transaction.subcategory);
                    }
                    
                    // Update modal title
                    const modalTitle = transaction.type === 'income' ? 'Edit Income' : 'Edit Expense';
                    document.getElementById('transactionModalLabel').textContent = modalTitle;
                    
                    // Show the modal
                    new bootstrap.Modal(document.getElementById('transactionModal')).show();
                })
                .catch(error => console.error('Error loading transaction details:', error));
        }
        
        function duplicateTransaction(transactionId) {
            // Similar to edit, but we don't set the ID, creating a new transaction
            fetch(`/finances/transactions/api/${transactionId}/`)
                .then(response => response.json())
                .then(transaction => {
                    // Fill form with transaction data but don't set ID (creates a new one)
                    document.getElementById('transaction-id').value = '';  // Important: empty for new transaction
                    document.getElementById('transaction-title').value = transaction.title;
                    document.getElementById('transaction-amount').value = transaction.amount;
                    document.getElementById('transaction-date').value = formatDateForInput(new Date()); // Current date
                    document.getElementById('transaction-type').value = transaction.type;
                    document.getElementById('transaction-category').value = transaction.category || '';
                    document.getElementById('transaction-notes').value = transaction.notes || '';
                    
                    // Set payment method if available, otherwise default to cash
                    if (transaction.payment_method) {
                        document.getElementById('transaction-payment-method').value = transaction.payment_method;
                    } else {
                        document.getElementById('transaction-payment-method').value = 'cash';
                    }
                    
                    // Load subcategories if category is selected
                    if (transaction.category) {
                        loadSubcategories(transaction.category, transaction.subcategory);
                    }
                    
                    // Update modal title (Duplicate)
                    const modalTitle = transaction.type === 'income' ? 'Duplicate Income' : 'Duplicate Expense';
                    document.getElementById('transactionModalLabel').textContent = modalTitle;
                    
                    // Show the modal
                    new bootstrap.Modal(document.getElementById('transactionModal')).show();
                })
                .catch(error => console.error('Error duplicating transaction:', error));
        }
        
        function saveTransaction() {
            // Get form data
            const transactionId = document.getElementById('transaction-id').value;
            const form = document.getElementById('transaction-form');
            const formData = new FormData(form);
            
            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Determine if this is a create or update operation
            const url = transactionId 
                ? `/finances/transactions/api/${transactionId}/update/` 
                : '/finances/transactions/api/create/';
            
            console.log("Saving transaction:", {
                id: transactionId,
                title: formData.get('title'),
                amount: formData.get('amount'),
                date: formData.get('date'),
                type: formData.get('type'),
                category: formData.get('category'),
                notes: formData.get('notes')
            });
            
            // Send AJAX request
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and reload transactions
                    bootstrap.Modal.getInstance(document.getElementById('transactionModal')).hide();
                    loadTransactionsForMonth();
                } else {
                    // Display error message
                    alert(data.error || 'An error occurred while saving the transaction.');
                }
            })
            .catch(error => {
                console.error('Error saving transaction:', error);
                alert('An error occurred while saving the transaction.');
            });
        }
        
        function deleteTransaction(transactionId) {
            fetch(`/finances/transactions/api/${transactionId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and reload transactions
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    loadTransactionsForMonth();
                } else {
                    // Display error message
                    alert(data.error || 'An error occurred while deleting the transaction.');
                }
            })
            .catch(error => {
                console.error('Error deleting transaction:', error);
                alert('An error occurred while deleting the transaction.');
            });
        }
        
        function loadSubcategories(categoryId, selectedSubcategoryId = null) {
            const subcategorySelect = document.getElementById('transaction-subcategory');
            
            if (!categoryId) {
                subcategorySelect.innerHTML = '<option value="">-- Select Subcategory --</option>';
                subcategorySelect.disabled = true;
                return;
            }
            
            // Fetch subcategories for selected category
            fetch(`/finances/api/categories/${categoryId}/subcategories/`)
                .then(response => response.json())
                .then(data => {
                    let options = '<option value="">-- Select Subcategory --</option>';
                    
                    data.forEach(subcategory => {
                        const selected = selectedSubcategoryId && subcategory.id == selectedSubcategoryId ? 'selected' : '';
                        options += `<option value="${subcategory.id}" ${selected}>${subcategory.name}</option>`;
                    });
                    
                    subcategorySelect.innerHTML = options;
                    subcategorySelect.disabled = data.length === 0;
                })
                .catch(error => console.error('Error loading subcategories:', error));
        }
        
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
    });
</script>
{% endblock %} 