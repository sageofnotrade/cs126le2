{% extends 'base.html' %}
{% load static %}

{% block title %}Transactions - Budget Tracker{% endblock %}

{% block navbar_title %}Transactions{% endblock %}

{% block extra_css %}
<style>
    /* Custom checkbox styling */
    .custom-checkbox {
        position: relative;
        min-width: 24px;
        height: 24px;
    }
    
    .custom-checkbox input[type="checkbox"] {
        opacity: 0;
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 2;
        cursor: pointer;
    }
    
    .custom-checkbox-label {
        position: absolute;
        top: 0;
        left: 0;
        width: 24px;
        height: 24px;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    
    .custom-checkbox input[type="checkbox"]:checked + .custom-checkbox-label {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .custom-checkbox input[type="checkbox"]:checked + .custom-checkbox-label::after {
        content: '';
        position: absolute;
        top: 5px;
        left: 8px;
        width: 6px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }
    
    .custom-checkbox input[type="checkbox"]:focus + .custom-checkbox-label {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Improve transaction list item */
    .transaction-item {
        transition: background-color 0.2s ease;
    }
    
    .transaction-item:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
    
    .icon-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
    }
</style>
{% endblock %}

{% block content %}
<header class="page-header mb-4 d-flex justify-content-between align-items-center">
    <h1 class="h2">Transactions</h1>
    <div class="actions">
        <button type="button" class="btn btn-success" id="add-income-btn">
            <i class="bi bi-plus-circle"></i> Add Income
        </button>
        <button type="button" class="btn btn-danger" id="add-expense-btn">
            <i class="bi bi-dash-circle"></i> Add Expense
        </button>
    </div>
</header>

<div class="row">
    <!-- Filter Container -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">Filter</h2>
            </div>
            <div class="card-body">
                <form id="transaction-filter-form">
                    <div class="mb-3">
                        <label for="category-filter" class="form-label">Category</label>
                        <select id="category-filter" class="form-select">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="from-to-filter" class="form-label">Title or Notes</label>
                        <input type="text" id="from-to-filter" class="form-control" placeholder="Search by title or notes">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label d-block">Type</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="expense-check" value="expense" checked>
                            <label class="form-check-label" for="expense-check">Expenses</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="income-check" value="income" checked>
                            <label class="form-check-label" for="income-check">Income</label>
                        </div>
                    </div>
                    
                    <button type="button" id="apply-filters-btn" class="btn btn-primary w-100">Apply Filters</button>
                    <button type="button" id="clear-filters-btn" class="btn btn-outline-secondary w-100 mt-2">Clear Filters</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Transactions List -->
    <div class="col-md-9">
        <div class="card border-0 shadow-sm mb-4">
            <!-- Month Navigation -->
            <div class="card-header d-flex justify-content-between align-items-center">
                <button type="button" id="prev-month-btn" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <h3 id="current-month" class="h5 mb-0">{{ current_month_name }} {{ current_year }}</h3>
                <button type="button" id="next-month-btn" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            
            <!-- Transactions Summary -->
            <div class="card-body pb-0">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-bold">Transactions: </span>
                        <span id="transaction-count">{{ transactions.count }}</span>
                    </div>
                    <div>
                        <span class="fw-bold">Total: </span>
                        <span id="transaction-total" class="{% if total_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ total_balance|floatformat:2 }}
                        </span>
                    </div>
                </div>
                <!-- Add select all option -->
                <div class="mt-3 d-flex justify-content-between align-items-center border-bottom pb-2">
                    <div class="d-flex align-items-center">
                        <div class="custom-checkbox me-2" style="min-width: 24px;">
                            <input class="select-all-transactions" type="checkbox" id="select-all-transactions">
                            <label class="custom-checkbox-label" for="select-all-transactions"></label>
                        </div>
                        <label class="form-check-label ms-1" for="select-all-transactions">
                            Select All
                        </label>
                    </div>
                    <div class="batch-actions invisible">
                        <button class="btn btn-sm btn-danger batch-delete" type="button">
                            Delete Selected (<span class="selected-count">0</span>)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Transactions List -->
            <div class="list-group list-group-flush">
                {% if transactions %}
                    {% for transaction in transactions %}
                    <div class="list-group-item d-flex justify-content-between align-items-center transaction-item position-relative">
                        <div class="d-flex align-items-center">
                            <div class="custom-checkbox me-2">
                                <input class="transaction-check" type="checkbox" value="{{ transaction.id }}" id="check-{{ transaction.id }}">
                                <label class="custom-checkbox-label" for="check-{{ transaction.id }}"></label>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="transaction-icon me-3">
                                    <span class="icon-wrapper rounded-circle bg-{% if transaction.type == 'income' %}success{% else %}danger{% endif %} p-2">
                                        <i class="{% if transaction.subcategory %}{{ transaction.subcategory.icon }}{% elif transaction.category %}{{ transaction.category.icon }}{% else %}bi bi-tag{% endif %} text-white"></i>
                                    </span>
                                </div>
                                <div>
                                    <div class="fw-bold">{{ transaction.title }}</div>
                                    <small class="text-muted">
                                        {% if transaction.subcategory %}{{ transaction.subcategory.name }}{% elif transaction.category %}{{ transaction.category.name }}{% else %}Uncategorized{% endif %}
                                        {% if transaction.notes %}- {{ transaction.notes }}{% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="text-end me-3">
                                <div class="{% if transaction.type == 'income' %}text-success{% else %}text-danger{% endif %} fw-bold">
                                    {% if transaction.type == 'income' %}+{% else %}-{% endif %}${{ transaction.amount|floatformat:2 }}
                                </div>
                                <small class="text-muted">{{ transaction.date|date:"m/d/Y" }}</small>
                            </div>
                            <!-- Transaction Actions -->
                            <div class="dropdown">
                                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item edit-transaction" href="#" data-id="{{ transaction.id }}">Edit</a></li>
                                    <li><a class="dropdown-item duplicate-transaction" href="#" data-id="{{ transaction.id }}">Duplicate</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item delete-transaction text-danger" href="#" data-id="{{ transaction.id }}">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                        <!-- Color indicator bar -->
                        <div class="position-absolute top-0 bottom-0 end-0 transaction-indicator {% if transaction.type == 'income' %}bg-success{% else %}bg-danger{% endif %}" style="width: 4px;"></div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="list-group-item py-4 text-center">
                        <p class="mb-0">No transactions found for this period</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Transaction Modal (for Add/Edit) -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="transaction-form">
                    {% csrf_token %}
                    <input type="hidden" id="transaction-id" name="transaction_id" value="">
                    <input type="hidden" id="transaction-type" name="type" value="expense">
                    
                    <div class="mb-3">
                        <label for="transaction-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="transaction-title" name="title" required>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="transaction-amount" class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text" id="currency-symbol">₱</span>
                                <input type="number" class="form-control" id="transaction-amount" name="amount" step="0.01" min="0.01" placeholder="0.00" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="transaction-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="transaction-date" name="date" required>
                        </div>
                        <div class="col-md-6">
                            <label for="transaction-time" class="form-label">Time</label>
                            <input type="time" class="form-control" id="transaction-time" name="time" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-account" class="form-label">Account</label>
                        <div class="input-group">
                            <select class="form-select account-select w-100" id="transaction-account" name="transaction_account" style="height: 46px;">
                                <option value="" data-icon="bi-bank">Choose your account</option>
                                {% for account in accounts %}
                                <option value="{{ account.id }}" data-account-type="{{ account.get_account_type }}" 
                                        data-icon="{% if account.get_account_type == 'credit' %}bi-credit-card{% elif account.get_account_type == 'wallet' %}bi-wallet2{% else %}bi-piggy-bank{% endif %}">
                                    {{ account.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-category" class="form-label">Category</label>
                        <div class="input-group">
                            <select class="form-select category-select w-100" id="transaction-category" name="category" style="height: 46px;">
                                <option value="" data-icon="bi-bookmark">Choose a category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" data-icon="{{ category.icon }}" data-type="{{ category.type }}" data-is-category="true">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" id="transaction-subcategory" name="subcategory" value="">
                    
                    <div class="mb-3">
                        <label for="transaction-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="transaction-notes" name="notes" rows="2" placeholder="Add notes about this transaction"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-transaction-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="delete-confirmation-message">Are you sure you want to delete this transaction? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Test if subcategories exist in the database - add this at the very top after DOMContentLoaded
        console.log("Checking if subcategories exist in the database...");
        
        // Get all category IDs
        const categorySelect = document.getElementById('transaction-category');
        if (categorySelect) {
            const categories = Array.from(categorySelect.options)
                .filter(opt => opt.getAttribute('data-is-category') === 'true')
                .map(opt => opt.value);
            
            console.log(`Found ${categories.length} categories to check for subcategories`);
            
            // Check each category for subcategories
            categories.forEach(categoryId => {
                if (!categoryId) return;
                
                fetch(`/finances/api/categories/${categoryId}/subcategories/`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(`Category ID ${categoryId} has ${data.length} subcategories:`, data);
                    })
                    .catch(error => {
                        console.error(`Error checking subcategories for category ${categoryId}:`, error);
                    });
            });
        }
        
        // Initialize styled account select
        initAccountSelect();
        initCategorySelect();
        
        // Current selected month/year (initialize with displayed values)
        let currentMonth = {% if current_month %}{{ current_month }}{% else %}new Date().getMonth() + 1{% endif %};
        let currentYear = {% if current_year %}{{ current_year }}{% else %}new Date().getFullYear(){% endif %};
        let deleteTransactionId = null;
        
        // Month navigation
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const currentMonthDisplay = document.getElementById('current-month');
        
        // Filter elements
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        
        // Transaction buttons
        const addIncomeBtn = document.getElementById('add-income-btn');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const saveTransactionBtn = document.getElementById('save-transaction-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const batchDeleteBtn = document.querySelector('.batch-delete');
        
        // Add event listeners for month navigation
        prevMonthBtn.addEventListener('click', () => {
            resetSelection();
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            loadTransactionsForMonth();
        });
        
        nextMonthBtn.addEventListener('click', () => {
            resetSelection();
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            loadTransactionsForMonth();
        });
        
        // Apply filters event
        applyFiltersBtn.addEventListener('click', () => {
            resetSelection();
            loadTransactionsForMonth();
        });
        
        // Clear filters event
        clearFiltersBtn.addEventListener('click', function() {
            // Reset filters
            document.getElementById('category-filter').value = '';
            document.getElementById('from-to-filter').value = '';
            document.getElementById('expense-check').checked = true;
            document.getElementById('income-check').checked = true;
            resetSelection();
            loadTransactionsForMonth();
        });
        
        // Add transaction buttons
        addIncomeBtn.addEventListener('click', () => {
            resetSelection();
            openTransactionModal('income');
        });
        
        addExpenseBtn.addEventListener('click', () => {
            resetSelection();
            openTransactionModal('expense');
        });
        
        // Implement global click handler to reset selection when clicking elsewhere
        document.addEventListener('click', function(e) {
            // Don't reset if clicking on checkboxes, delete button, or elements inside the transaction item
            if (e.target.closest('.custom-checkbox') || 
                e.target.closest('.batch-delete') ||
                e.target.closest('.transaction-item') ||
                e.target.closest('.batch-actions') ||
                e.target.closest('#deleteModal')) {
                return;
            }
            
            // Reset selection for clicks outside of selection-related elements
            resetSelection();
        });
        
        // Save transaction
        saveTransactionBtn.addEventListener('click', saveTransaction);
        
        // Delete transaction
        confirmDeleteBtn.addEventListener('click', () => {
            if (deleteTransactionId) {
                deleteTransaction(deleteTransactionId);
            }
        });
        
        // Delegate event listeners for transaction actions (edit, duplicate, delete)
        document.addEventListener('click', function(e) {
            // Edit transaction
            if (e.target.classList.contains('edit-transaction') || e.target.parentElement.classList.contains('edit-transaction')) {
                e.preventDefault();
                const element = e.target.classList.contains('edit-transaction') ? e.target : e.target.parentElement;
                const transactionId = element.dataset.id;
                editTransaction(transactionId);
            }
            
            // Duplicate transaction
            if (e.target.classList.contains('duplicate-transaction') || e.target.parentElement.classList.contains('duplicate-transaction')) {
                e.preventDefault();
                const element = e.target.classList.contains('duplicate-transaction') ? e.target : e.target.parentElement;
                const transactionId = element.dataset.id;
                duplicateTransaction(transactionId);
            }
            
            // Delete transaction
            if (e.target.classList.contains('delete-transaction') || e.target.parentElement.classList.contains('delete-transaction')) {
                e.preventDefault();
                const element = e.target.classList.contains('delete-transaction') ? e.target : e.target.parentElement;
                const transactionId = element.dataset.id;
                deleteTransactionId = transactionId;
                
                // Show delete confirmation modal
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            }
        });
        
        // Handle category change for subcategories
        document.getElementById('transaction-category').addEventListener('change', function() {
            loadSubcategoriesInCategoryDropdown(this.value);
        });
        
        // Filter accounts when transaction type changes
        document.getElementById('transaction-type').addEventListener('change', function() {
            filterAccountsByTransactionType(this.value);
            filterCategoriesByTransactionType(this.value);
        });
        
        // Functions
        function initAccountSelect() {
            const accountSelect = document.getElementById('transaction-account');
            
            // Initialize select with icon
            setTimeout(updateAccountSelectIcon, 0);
            
            // Listen for changes to update the icon
            accountSelect.addEventListener('change', updateAccountSelectIcon);
        }
        
        function updateAccountSelectIcon() {
            const accountSelect = document.getElementById('transaction-account');
            const selectedOption = accountSelect.options[accountSelect.selectedIndex];
            const iconClass = selectedOption ? selectedOption.getAttribute('data-icon') : null;
            const selectedValue = accountSelect.value;
            
            // Clear the input group first
            const inputGroup = accountSelect.closest('.input-group');
            if (inputGroup) {
                // Store original select
                const originalSelect = accountSelect.cloneNode(true);
                
                // Clear all contents
                inputGroup.innerHTML = '';
                
                // Re-add the select
                inputGroup.appendChild(originalSelect);
                
                // Update the reference to the select
                const newSelect = inputGroup.querySelector('select');
                
                // Set the selected value (important for showing the right option)
                if (selectedValue) {
                    newSelect.value = selectedValue;
                }
                
                if (iconClass) {
                    // Create a wrapper to hold both the select and icon
                    const wrapper = document.createElement('div');
                    wrapper.className = 'position-relative w-100';
                    
                    // Create the icon element
                    const iconElement = document.createElement('i');
                    iconElement.className = `bi ${iconClass} position-absolute`;
                    iconElement.style.left = '15px';
                    iconElement.style.top = '50%';
                    iconElement.style.transform = 'translateY(-50%)';
                    iconElement.style.zIndex = '10';
                    iconElement.style.color = '#6c757d';
                    iconElement.style.fontSize = '1.1rem';
                    iconElement.style.width = '20px';
                    iconElement.style.textAlign = 'center';
                    
                    // Set styles for the select
                    newSelect.style.paddingLeft = '40px';
                    
                    // Add icon and select to wrapper
                    wrapper.appendChild(iconElement);
                    wrapper.appendChild(newSelect);
                    
                    // Replace select with wrapper
                    inputGroup.innerHTML = '';
                    inputGroup.appendChild(wrapper);
                    
                    // Re-add event listeners
                    newSelect.addEventListener('change', function() {
                        filterAccountsByTransactionType(document.getElementById('transaction-type').value);
                        updateAccountSelectIcon();
                    });
                } else {
                    // No icon needed
                    newSelect.style.paddingLeft = '';
                }
            }
        }
        
        function initCategorySelect() {
            const categorySelect = document.getElementById('transaction-category');
            
            // Initialize select with icon
            setTimeout(updateCategorySelectIcon, 0);
            
            // Preload all subcategories based on current transaction type
            setTimeout(() => {
                const transactionType = document.getElementById('transaction-type').value;
                preloadAllSubcategories(transactionType);
            }, 100);
            
            // Listen for changes to update the icon
            categorySelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                
                // Check if the selected option is a subcategory
                if (selectedOption && selectedOption.hasAttribute('data-subcategory-id')) {
                    // Set the subcategory ID in the hidden field
                    document.getElementById('transaction-subcategory').value = selectedOption.getAttribute('data-subcategory-id');
                    
                    // Also mark the parent category as the selected category (for processing)
                    const parentCategoryId = selectedOption.getAttribute('data-parent-category');
                    if (parentCategoryId) {
                        // We're just setting the internal value for form submission, not changing the visible selection
                        document.getElementById('transaction-category').setAttribute('data-selected-category', parentCategoryId);
                    }
                } else {
                    // It's a main category, clear subcategory selection
                    document.getElementById('transaction-subcategory').value = '';
                    
                    // If it's a category, load its subcategories
                    if (selectedOption && selectedOption.getAttribute('data-is-category') === 'true') {
                        loadSubcategoriesInCategoryDropdown(this.value);
                    }
                }
                
                // Update the icon
                updateCategorySelectIcon();
            });
        }
        
        function updateCategorySelectIcon() {
            const categorySelect = document.getElementById('transaction-category');
            const selectedOption = categorySelect.options[categorySelect.selectedIndex];
            const iconClass = selectedOption ? selectedOption.getAttribute('data-icon') : null;
            const selectedValue = categorySelect.value;
            
            // Clear the input group first
            const inputGroup = categorySelect.closest('.input-group');
            if (inputGroup) {
                // Store original select
                const originalSelect = categorySelect.cloneNode(true);
                
                // Clear all contents
                inputGroup.innerHTML = '';
                
                // Re-add the select
                inputGroup.appendChild(originalSelect);
                
                // Update the reference to the select
                const newSelect = inputGroup.querySelector('select');
                
                // Set the selected value (important for showing the right option)
                if (selectedValue) {
                    newSelect.value = selectedValue;
                }
                
                if (iconClass) {
                    // Create a wrapper to hold both the select and icon
                    const wrapper = document.createElement('div');
                    wrapper.className = 'position-relative w-100';
                    
                    // Create the icon element
                    const iconElement = document.createElement('i');
                    iconElement.className = `bi ${iconClass} position-absolute`;
                    iconElement.style.left = '15px';
                    iconElement.style.top = '50%';
                    iconElement.style.transform = 'translateY(-50%)';
                    iconElement.style.zIndex = '10';
                    iconElement.style.color = '#6c757d';
                    iconElement.style.fontSize = '1.1rem';
                    iconElement.style.width = '20px';
                    iconElement.style.textAlign = 'center';
                    
                    // Set styles for the select
                    newSelect.style.paddingLeft = '40px';
                    
                    // Add icon and select to wrapper
                    wrapper.appendChild(iconElement);
                    wrapper.appendChild(newSelect);
                    
                    // Replace select with wrapper
                    inputGroup.innerHTML = '';
                    inputGroup.appendChild(wrapper);
                    
                    // Re-add event listeners
                    newSelect.addEventListener('change', function() {
                        loadSubcategoriesInCategoryDropdown(this.value);
                        updateCategorySelectIcon();
                    });
                } else {
                    // No icon needed
                    newSelect.style.paddingLeft = '';
                }
            }
        }
        
        function loadTransactionsForMonth() {
            // Format the month name to display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                              'July', 'August', 'September', 'October', 'November', 'December'];
            currentMonthDisplay.textContent = `${monthNames[currentMonth-1]} ${currentYear}`;
            
            // Get filter values
            const categoryId = document.getElementById('category-filter').value;
            const searchTerm = document.getElementById('from-to-filter').value;
            const includeExpenses = document.getElementById('expense-check').checked;
            const includeIncome = document.getElementById('income-check').checked;
            
            // Build transaction types array
            const types = [];
            if (includeExpenses) types.push('expense');
            if (includeIncome) types.push('income');
            
            // AJAX call to get filtered transactions
            fetch(`/finances/transactions/api/?month=${currentMonth}&year=${currentYear}&category=${categoryId}&search=${searchTerm}&types=${types.join(',')}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Received transactions data:", data.transactions);
                    updateTransactionsList(data.transactions);
                    document.getElementById('transaction-count').textContent = data.count;
                    document.getElementById('transaction-total').textContent = `$${data.total.toFixed(2)}`;
                    
                    // Update class based on total value
                    const totalElement = document.getElementById('transaction-total');
                    if (data.total >= 0) {
                        totalElement.classList.remove('text-danger');
                        totalElement.classList.add('text-success');
                    } else {
                        totalElement.classList.remove('text-success');
                        totalElement.classList.add('text-danger');
                    }
                })
                .catch(error => console.error('Error loading transactions:', error));
        }
        
        function updateTransactionsList(transactions) {
            const listContainer = document.querySelector('.list-group');
            
            if (transactions.length === 0) {
                listContainer.innerHTML = `
                    <div class="list-group-item py-4 text-center">
                        <p class="mb-0">No transactions found for this period</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            transactions.forEach(transaction => {
                // Determine which icon to use - prioritize subcategory if available
                const iconToUse = transaction.subcategory_icon || transaction.category_icon || 'bi bi-tag';
                const nameToDisplay = transaction.subcategory_name || transaction.category_name || 'Uncategorized';
                
                html += `
                <div class="list-group-item d-flex justify-content-between align-items-center transaction-item position-relative">
                    <div class="d-flex align-items-center">
                        <div class="custom-checkbox me-2">
                            <input class="transaction-check" type="checkbox" value="${transaction.id}" id="check-${transaction.id}">
                            <label class="custom-checkbox-label" for="check-${transaction.id}"></label>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="transaction-icon me-3">
                                <span class="icon-wrapper rounded-circle bg-${transaction.type === 'income' ? 'success' : 'danger'} p-2">
                                    <i class="${iconToUse} text-white"></i>
                                </span>
                            </div>
                            <div>
                                <div class="fw-bold">${transaction.title}</div>
                                <small class="text-muted">
                                    ${nameToDisplay}
                                    ${transaction.notes ? '- ' + transaction.notes : ''}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="text-end me-3">
                            <div class="${transaction.type === 'income' ? 'text-success' : 'text-danger'} fw-bold">
                                ${transaction.type === 'income' ? '+' : '-'}$${parseFloat(transaction.amount).toFixed(2)}
                            </div>
                            <small class="text-muted">${formatDate(transaction.date)}</small>
                        </div>
                        <!-- Transaction Actions -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item edit-transaction" href="#" data-id="${transaction.id}">Edit</a></li>
                                <li><a class="dropdown-item duplicate-transaction" href="#" data-id="${transaction.id}">Duplicate</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item delete-transaction text-danger" href="#" data-id="${transaction.id}">Delete</a></li>
                            </ul>
                        </div>
                    </div>
                    <!-- Color indicator bar -->
                    <div class="position-absolute top-0 bottom-0 end-0 transaction-indicator ${transaction.type === 'income' ? 'bg-success' : 'bg-danger'}" style="width: 4px;"></div>
                </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
        }
        
        function openTransactionModal(type) {
            // Reset form
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-id').value = '';
            document.getElementById('transaction-type').value = type;
            
            // Set default date and time to now
            const now = new Date();
            document.getElementById('transaction-date').value = formatDateForInput(now);
            document.getElementById('transaction-time').value = formatTimeForInput(now);
            
            // Filter accounts based on transaction type
            filterAccountsByTransactionType(type);
            
            // Filter categories based on transaction type
            filterCategoriesByTransactionType(type);
            
            // Update icons for select dropdowns
            updateAccountSelectIcon();
            updateCategorySelectIcon();
            
            // Load subcategories for all visible categories (Pre-load subcategories)
            preloadAllSubcategories(type);
            
            // Update modal title based on transaction type
            const modalTitle = type === 'income' ? 'Add Income' : 'Add Expense';
            document.getElementById('transactionModalLabel').textContent = modalTitle;
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('transactionModal')).show();
        }
        
        // Function to preload subcategories for all visible categories
        function preloadAllSubcategories(transactionType) {
            const categorySelect = document.getElementById('transaction-category');
            const categories = Array.from(categorySelect.options)
                .filter(opt => opt.getAttribute('data-is-category') === 'true' && 
                              (!opt.getAttribute('data-type') || opt.getAttribute('data-type') === transactionType));
            
            // Load subcategories for each visible category
            if (categories.length > 0) {
                // Process categories one by one
                let index = 0;
                
                function processNextCategory() {
                    if (index < categories.length) {
                        const categoryId = categories[index].value;
                        
                        // Fetch subcategories for this category
                        fetch(`/finances/api/categories/${categoryId}/subcategories/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.length > 0) {
                                    // Remove any existing subcategory options for this category
                                    const existingSubcats = Array.from(categorySelect.options)
                                        .filter(opt => opt.getAttribute('data-parent-category') === categoryId);
                                    existingSubcats.forEach(opt => opt.remove());
                                    
                                    // Add subcategory options after the parent category
                                    const categoryOption = Array.from(categorySelect.options)
                                        .find(opt => opt.value === categoryId);
                                    const categoryIndex = Array.from(categorySelect.options).indexOf(categoryOption);
                                    
                                    // Add subcategories
                                    data.forEach((subcategory, subIndex) => {
                                        const option = document.createElement('option');
                                        option.value = `subcat-${subcategory.id}`;
                                        option.setAttribute('data-icon', subcategory.icon || 'bi-tag-fill');
                                        option.setAttribute('data-parent-category', categoryId);
                                        option.setAttribute('data-subcategory-id', subcategory.id);
                                        option.setAttribute('data-type', categoryOption.getAttribute('data-type'));
                                        option.style.paddingLeft = '25px';
                                        option.textContent = `↳ ${subcategory.name}`;
                                        
                                        // Insert after parent category and any previously added subcategories
                                        categorySelect.insertBefore(option, categorySelect.options[categoryIndex + subIndex + 1]);
                                    });
                                }
                                
                                // Process the next category
                                index++;
                                processNextCategory();
                            })
                            .catch(error => {
                                console.error('Error loading subcategories:', error);
                                index++;
                                processNextCategory();
                            });
                    } else {
                        // All categories processed, update category icon
                        updateCategorySelectIcon();
                    }
                }
                
                // Start processing categories
                processNextCategory();
            }
        }
        
        function filterAccountsByTransactionType(transactionType) {
            const accountSelect = document.getElementById('transaction-account');
            const options = accountSelect.querySelectorAll('option');
            
            options.forEach(option => {
                // Skip the default empty option
                if (!option.value) return;
                
                const accountType = option.getAttribute('data-account-type');
                
                // For income transactions, hide credit accounts
                if (transactionType === 'income' && accountType === 'credit') {
                    option.style.display = 'none';
                } else {
                    option.style.display = '';
                }
            });
            
            // Reset selection to default if the currently selected account is now hidden
            const selectedOption = accountSelect.options[accountSelect.selectedIndex];
            if (selectedOption && selectedOption.style.display === 'none') {
                accountSelect.value = '';
            }
        }
        
        function editTransaction(transactionId) {
            // Fetch transaction details
            fetch(`/finances/transactions/api/${transactionId}/`)
                .then(response => response.json())
                .then(transaction => {
                    console.log("Transaction details for editing:", transaction);
                    
                    // Fill form with transaction data
                    document.getElementById('transaction-id').value = transaction.id;
                    document.getElementById('transaction-title').value = transaction.title;
                    document.getElementById('transaction-amount').value = transaction.amount;
                    document.getElementById('transaction-date').value = formatDateForInput(new Date(transaction.date));
                    
                    // Set time if available
                    if (transaction.time) {
                        document.getElementById('transaction-time').value = transaction.time.substring(0, 5); // HH:MM format
                    } else {
                        document.getElementById('transaction-time').value = formatTimeForInput(new Date());
                    }
                    
                    document.getElementById('transaction-type').value = transaction.type;
                    document.getElementById('transaction-notes').value = transaction.notes || '';
                    
                    // Set account if available
                    if (transaction.transaction_account) {
                        document.getElementById('transaction-account').value = transaction.transaction_account;
                    }
                    
                    // Filter accounts based on transaction type
                    filterAccountsByTransactionType(transaction.type);
                    
                    // Filter categories based on transaction type
                    filterCategoriesByTransactionType(transaction.type);
                    
                    // Load category and subcategory
                    if (transaction.category) {
                        // First set the main category
                        document.getElementById('transaction-category').value = transaction.category;
                        
                        // Load subcategories for this category and select the right one if present
                        if (transaction.subcategory) {
                            // Set the hidden subcategory field
                            document.getElementById('transaction-subcategory').value = transaction.subcategory;
                            
                            // We need to load all subcategories first to ensure proper selection
                            const transactionType = document.getElementById('transaction-type').value;
                            preloadAllSubcategories(transactionType);
                            
                            // Give it a moment to load, then try to select the subcategory
                            setTimeout(() => {
                                // Find the subcategory option
                                const subcategoryOption = Array.from(document.getElementById('transaction-category').options)
                                    .find(opt => opt.getAttribute('data-subcategory-id') === transaction.subcategory.toString());
                                
                                // Select it if found
                                if (subcategoryOption) {
                                    document.getElementById('transaction-category').value = subcategoryOption.value;
                                    console.log("Selected subcategory option:", subcategoryOption.textContent);
                                }
                                
                                // Update the icon
                                updateCategorySelectIcon();
                            }, 300);
                        } else {
                            // Just load subcategories for the selected category
                            loadSubcategoriesInCategoryDropdown(transaction.category);
                        }
                    }
                    
                    // Update the icons for select dropdowns
                    updateAccountSelectIcon();
                    updateCategorySelectIcon();
                    
                    // Update modal title
                    const modalTitle = transaction.type === 'income' ? 'Edit Income' : 'Edit Expense';
                    document.getElementById('transactionModalLabel').textContent = modalTitle;
                    
                    // Show the modal
                    new bootstrap.Modal(document.getElementById('transactionModal')).show();
                })
                .catch(error => console.error('Error loading transaction details:', error));
        }
        
        function duplicateTransaction(transactionId) {
            // Similar to edit, but we don't set the ID, creating a new transaction
            fetch(`/finances/transactions/api/${transactionId}/`)
                .then(response => response.json())
                .then(transaction => {
                    // Fill form with transaction data but don't set ID (creates a new one)
                    document.getElementById('transaction-id').value = '';  // Important: empty for new transaction
                    document.getElementById('transaction-title').value = transaction.title;
                    document.getElementById('transaction-amount').value = transaction.amount;
                    document.getElementById('transaction-date').value = formatDateForInput(new Date()); // Current date
                    document.getElementById('transaction-type').value = transaction.type;
                    document.getElementById('transaction-notes').value = transaction.notes || '';
                    
                    // Filter accounts based on transaction type
                    filterAccountsByTransactionType(transaction.type);
                    
                    // Filter categories based on transaction type
                    filterCategoriesByTransactionType(transaction.type);
                    
                    // Load category and subcategory
                    if (transaction.category) {
                        // First set the main category
                        document.getElementById('transaction-category').value = transaction.category;
                        
                        // Load subcategories for this category and select the right one if present
                        if (transaction.subcategory) {
                            // Set the hidden subcategory field
                            document.getElementById('transaction-subcategory').value = transaction.subcategory;
                            
                            // We need to load all subcategories first to ensure proper selection
                            const transactionType = document.getElementById('transaction-type').value;
                            preloadAllSubcategories(transactionType);
                            
                            // Give it a moment to load, then try to select the subcategory
                            setTimeout(() => {
                                // Find the subcategory option
                                const subcategoryOption = Array.from(document.getElementById('transaction-category').options)
                                    .find(opt => opt.getAttribute('data-subcategory-id') === transaction.subcategory.toString());
                                
                                // Select it if found
                                if (subcategoryOption) {
                                    document.getElementById('transaction-category').value = subcategoryOption.value;
                                }
                                
                                // Update the icon
                                updateCategorySelectIcon();
                            }, 300);
                        } else {
                            // Just load subcategories for the selected category
                            loadSubcategoriesInCategoryDropdown(transaction.category);
                        }
                    }
                    
                    // Update the icons for select dropdowns
                    updateAccountSelectIcon();
                    updateCategorySelectIcon();
                    
                    // Update modal title (Duplicate)
                    const modalTitle = transaction.type === 'income' ? 'Duplicate Income' : 'Duplicate Expense';
                    document.getElementById('transactionModalLabel').textContent = modalTitle;
                    
                    // Show the modal
                    new bootstrap.Modal(document.getElementById('transactionModal')).show();
                })
                .catch(error => console.error('Error duplicating transaction:', error));
        }
        
        function saveTransaction() {
            // Get form data
            const transactionId = document.getElementById('transaction-id').value;
            const form = document.getElementById('transaction-form');
            const formData = new FormData(form);
            
            // Handle the category and subcategory
            const categorySelect = document.getElementById('transaction-category');
            const selectedOption = categorySelect.options[categorySelect.selectedIndex];
            
            // Check if the selected option is a subcategory
            if (selectedOption && selectedOption.hasAttribute('data-subcategory-id')) {
                // For subcategories, we need to set the correct category ID and subcategory ID
                formData.set('category', selectedOption.getAttribute('data-parent-category'));
                formData.set('subcategory', selectedOption.getAttribute('data-subcategory-id'));
            } else if (selectedOption && selectedOption.getAttribute('data-is-category') === 'true') {
                // For main categories, make sure subcategory is empty
                formData.set('subcategory', '');
            }
            
            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Determine if this is a create or update operation
            const url = transactionId 
                ? `/finances/transactions/api/${transactionId}/update/` 
                : '/finances/transactions/api/create/';
            
            console.log("Saving transaction:", {
                id: transactionId,
                title: formData.get('title'),
                amount: formData.get('amount'),
                date: formData.get('date'),
                time: formData.get('time'),
                type: formData.get('type'),
                category: formData.get('category'),
                subcategory: formData.get('subcategory'),
                transaction_account: formData.get('transaction_account'),
                notes: formData.get('notes')
            });
            
            // Send AJAX request
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and reload transactions
                    bootstrap.Modal.getInstance(document.getElementById('transactionModal')).hide();
                    loadTransactionsForMonth();
                } else {
                    // Display error message
                    alert(data.error || 'An error occurred while saving the transaction.');
                }
            })
            .catch(error => {
                console.error('Error saving transaction:', error);
                alert('An error occurred while saving the transaction.');
            });
        }
        
        function deleteTransaction(transactionId) {
            // Handle both single and batch deletions
            const isArray = Array.isArray(transactionId);
            
            if (isArray) {
                // For batch deletions, we'll handle each transaction individually
                let successCount = 0;
                let errorCount = 0;
                let processedCount = 0;
                
                // Process each transaction one by one
                transactionId.forEach(id => {
                    fetch(`/finances/transactions/api/${id}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        processedCount++;
                        
                        if (data.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                        
                        // When all transactions are processed, show results and refresh
                        if (processedCount === transactionId.length) {
                            // Close modal
                            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                            
                            // Show results
                            if (errorCount > 0) {
                                alert(`Deleted ${successCount} transaction(s). Failed to delete ${errorCount} transaction(s).`);
                            }
                            
                            // Refresh the list and reset selection
                            loadTransactionsForMonth();
                            resetSelection();
                        }
                    })
                    .catch(error => {
                        processedCount++;
                        errorCount++;
                        
                        console.error(`Error deleting transaction ${id}:`, error);
                        
                        // When all transactions are processed, show results and refresh
                        if (processedCount === transactionId.length) {
                            // Close modal
                            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                            
                            // Show results
                            alert(`Deleted ${successCount} transaction(s). Failed to delete ${errorCount} transaction(s).`);
                            
                            // Refresh the list and reset selection
                            loadTransactionsForMonth();
                            resetSelection();
                        }
                    });
                });
            } else {
                // Single transaction deletion - original code
                fetch(`/finances/transactions/api/${transactionId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close modal and reload transactions
                        bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                        loadTransactionsForMonth();
                    } else {
                        // Display error message
                        alert(data.error || 'An error occurred while deleting the transaction.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting transaction:', error);
                    alert('An error occurred while deleting the transaction.');
                });
            }
        }
        
        function loadSubcategoriesInCategoryDropdown(categoryId, selectedSubcategoryId = null) {
            if (!categoryId) {
                // Reset hidden subcategory field
                document.getElementById('transaction-subcategory').value = '';
                updateCategorySelectIcon();
                return;
            }
            
            console.log(`Loading subcategories for category ID: ${categoryId}, selectedSubcategory: ${selectedSubcategoryId}`);
            
            // Fetch subcategories for selected category
            fetch(`/finances/api/categories/${categoryId}/subcategories/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Received subcategories data:', data);
                    
                    const categorySelect = document.getElementById('transaction-category');
                    const categoryOption = Array.from(categorySelect.options).find(opt => opt.value === categoryId);
                    
                    if (!categoryOption) {
                        console.warn('Category option not found in dropdown');
                        return;
                    }
                    
                    // Get all subcategory options
                    const subcategoryOptions = Array.from(categorySelect.options).filter(opt => 
                        opt.getAttribute('data-parent-category') === categoryId);
                    
                    // Remove any existing subcategory options for this category
                    console.log(`Removing ${subcategoryOptions.length} existing subcategory options`);
                    subcategoryOptions.forEach(opt => opt.remove());
                    
                    if (data.length === 0) {
                        console.log('No subcategories found for this category');
                        updateCategorySelectIcon();
                        return;
                    }
                    
                    // Add subcategory options after the parent category
                    const categoryIndex = Array.from(categorySelect.options).indexOf(categoryOption);
                    console.log(`Adding ${data.length} subcategories after category at index ${categoryIndex}`);
                    
                    // Store original selected value
                    const originalSelectedValue = categorySelect.value;
                    
                    data.forEach((subcategory, index) => {
                        const option = document.createElement('option');
                        option.value = `subcat-${subcategory.id}`; // Prefix to identify as subcategory
                        option.setAttribute('data-icon', subcategory.icon || 'bi-tag-fill');
                        option.setAttribute('data-parent-category', categoryId);
                        option.setAttribute('data-subcategory-id', subcategory.id);
                        option.setAttribute('data-type', categoryOption.getAttribute('data-type'));
                        option.style.paddingLeft = '25px'; // Indent to show hierarchy
                        option.textContent = `↳ ${subcategory.name}`;
                        
                        // Set as selected if it matches the selected subcategory ID
                        if (selectedSubcategoryId && subcategory.id == selectedSubcategoryId) {
                            option.selected = true;
                            console.log(`Selected subcategory: ${subcategory.name}`);
                        }
                        
                        // Insert after parent category
                        categorySelect.insertBefore(option, categorySelect.options[categoryIndex + index + 1]);
                    });
                    
                    // Restore selection if no subcategory was selected
                    if (!selectedSubcategoryId) {
                        categorySelect.value = originalSelectedValue;
                    }
                    
                    // Update the icon
                    updateCategorySelectIcon();
                    
                    console.log('Subcategories added successfully');
                    
                    // If a subcategory was selected, update the hidden field
                    if (selectedSubcategoryId) {
                        document.getElementById('transaction-subcategory').value = selectedSubcategoryId;
                        
                        // Find and select the subcategory option
                        const subcatOption = Array.from(categorySelect.options).find(
                            opt => opt.getAttribute('data-subcategory-id') == selectedSubcategoryId
                        );
                        
                        if (subcatOption) {
                            categorySelect.value = subcatOption.value;
                            console.log(`Selected subcategory with value: ${subcatOption.value}`);
                        }
                    }
                })
                .catch(error => console.error('Error loading subcategories:', error));
        }
        
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatTimeForInput(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        function filterCategoriesByTransactionType(transactionType) {
            const categorySelect = document.getElementById('transaction-category');
            const options = categorySelect.querySelectorAll('option');
            
            options.forEach(option => {
                // Skip the default empty option
                if (!option.value) return;
                
                const categoryType = option.getAttribute('data-type');
                
                // Show only categories matching the current transaction type
                if (categoryType && categoryType !== transactionType) {
                    option.style.display = 'none';
                } else {
                    option.style.display = '';
                }
            });
            
            // Reset selection to default if the currently selected category is now hidden
            const selectedOption = categorySelect.options[categorySelect.selectedIndex];
            if (selectedOption && selectedOption.style.display === 'none') {
                categorySelect.value = '';
                
                // Clear subcategories since the category changed
                document.getElementById('transaction-subcategory').innerHTML = '<option value="" data-icon="bi-tags">Choose a subcategory</option>';
                document.getElementById('transaction-subcategory').disabled = true;
                updateSubcategorySelectIcon();
            }
            
            // Update the category icon (directly call to ensure it updates)
            setTimeout(updateCategorySelectIcon, 0);
        }
        
        // Checkbox and batch actions handling
        const selectAllCheckbox = document.getElementById('select-all-transactions');
        const batchActionsMenu = document.querySelector('.batch-actions');
        const selectedCountDisplay = document.querySelector('.selected-count');
        
        // Event listener for select all checkbox
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('.transaction-check');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
                
                updateBatchActionsVisibility();
            });
        }
        
        // Event delegation for individual checkboxes
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('transaction-check')) {
                updateBatchActionsVisibility();
                
                // If any checkbox is unchecked, uncheck the "Select All" checkbox
                if (!e.target.checked && selectAllCheckbox.checked) {
                    selectAllCheckbox.checked = false;
                }
                
                // If all checkboxes are checked, check the "Select All" checkbox
                if (areAllTransactionsSelected()) {
                    selectAllCheckbox.checked = true;
                }
            }
        });
        
        // Batch actions event handlers
        document.querySelector('.batch-delete')?.addEventListener('click', function(e) {
            e.preventDefault();
            const selectedIds = getSelectedTransactionIds();
            if (selectedIds.length > 0) {
                // Update delete confirmation message
                const message = selectedIds.length === 1 
                    ? 'Are you sure you want to delete this transaction? This action cannot be undone.'
                    : `Are you sure you want to delete these ${selectedIds.length} transactions? This action cannot be undone.`;
                
                document.getElementById('delete-confirmation-message').textContent = message;
                
                // Store selected IDs for deletion
                deleteTransactionId = selectedIds;
                
                // Show delete confirmation modal
                new bootstrap.Modal(document.getElementById('deleteModal')).show();
            }
        });
        
        document.querySelector('.batch-export')?.addEventListener('click', function(e) {
            e.preventDefault();
            const selectedIds = getSelectedTransactionIds();
            if (selectedIds.length > 0) {
                // In a production app, you would implement export functionality
                alert(`Feature not implemented: Would export transaction IDs: ${selectedIds.join(', ')}`);
            }
        });
        
        document.querySelector('.batch-cancel')?.addEventListener('click', function(e) {
            e.preventDefault();
            resetSelection();
        });
        
        // Helper functions for batch actions
        function updateBatchActionsVisibility() {
            const selectedCount = getSelectedTransactionIds().length;
            const selectedCountDisplay = document.querySelector('.selected-count');
            const batchActionsMenu = document.querySelector('.batch-actions');
            
            if (selectedCountDisplay) {
                selectedCountDisplay.textContent = selectedCount;
            }
            
            if (batchActionsMenu) {
                if (selectedCount > 0) {
                    batchActionsMenu.classList.remove('invisible');
                } else {
                    batchActionsMenu.classList.add('invisible');
                }
            }
        }
        
        function getSelectedTransactionIds() {
            const checkboxes = document.querySelectorAll('.transaction-check:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }
        
        function areAllTransactionsSelected() {
            const allCheckboxes = document.querySelectorAll('.transaction-check');
            const checkedCheckboxes = document.querySelectorAll('.transaction-check:checked');
            return allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length;
        }
        
        function resetSelection() {
            const checkboxes = document.querySelectorAll('.transaction-check');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            
            updateBatchActionsVisibility();
        }
    });
</script>
{% endblock %} 