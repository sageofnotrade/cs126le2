{% extends 'base.html' %}
{% load static %}

{% block title %}Transactions - Budget Tracker{% endblock %}

{% block navbar_title %}Transactions{% endblock %}

{% block body_attributes %}data-selected-category="{{ selected_category }}" data-selected-subcategory="{{ selected_subcategory }}" id="page-body"{% endblock %}

{% block extra_css %}
<style>
    /* Custom checkbox styling */
    .custom-checkbox {
        position: relative;
        min-width: 24px;
        height: 24px;
    }
    
    .custom-checkbox input[type="checkbox"] {
        opacity: 0;
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 2;
        cursor: pointer;
    }
    
    .custom-checkbox-label {
        position: absolute;
        top: 0;
        left: 0;
        width: 24px;
        height: 24px;
        background-color: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    
    .custom-checkbox input[type="checkbox"]:checked + .custom-checkbox-label {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .custom-checkbox input[type="checkbox"]:checked + .custom-checkbox-label::after {
        content: '';
        position: absolute;
        top: 5px;
        left: 8px;
        width: 6px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }
    
    .custom-checkbox input[type="checkbox"]:focus + .custom-checkbox-label {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    /* Enhanced card and layout styling */
    .card {
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: none;
        overflow: hidden;
    }
    
    .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }
    
    .card-header {
        background-color: #fff;
        padding: 1.2rem 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-weight: 600;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    /* Improved transaction list item */
    .transaction-item {
        padding: 1rem 1.5rem;
        transition: all 0.2s ease;
        border-left: none;
        border-right: none;
        border-radius: 0;
        margin-bottom: 0;
        border-top: none;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }
    
    .transaction-item:hover {
        background-color: transparent;
        transform: none;
    }
    
    /* Enhanced icon styling */
    .icon-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 42px;
        height: 42px;
        border-radius: 10px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }
    
    /* Transaction indicator styling */
    .transaction-indicator {
        border-radius: 0 0.375rem 0.375rem 0;
        width: 5px !important;
    }
    
    /* Enhance buttons */
    .btn {
        border-radius: 8px;
        font-weight: 500;
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
    }
    
    .btn-success, .btn-danger {
        padding: 0.5rem 1.25rem;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Month navigation styling */
    #prev-month-btn, #next-month-btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        padding: 0;
    }
    
    #current-month {
        font-weight: 600;
        font-size: 1.1rem;
        color: #333;
    }
    
    /* Better spacing */
    .page-header {
        margin-bottom: 1.5rem !important;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    /* Transaction type filter buttons */
    .btn-group [data-filter].active {
        font-weight: bold;
    }
    
    .btn-outline-success.active {
        box-shadow: 0 0 0 0.15rem rgba(25, 135, 84, 0.15);
    }
    
    .btn-outline-danger.active {
        box-shadow: 0 0 0 0.15rem rgba(220, 53, 69, 0.15);
    }
    
    .btn-outline-secondary.active {
        box-shadow: 0 0 0 0.15rem rgba(108, 117, 125, 0.15);
    }
    
    /* Dropdown toggle button styling */
    .dropdown-toggle::after {
        display: inline-block !important;
        margin-left: 0.255em;
        vertical-align: 0.255em;
        content: "" !important;
        border-top: 0.3em solid;
        border-right: 0.3em solid transparent;
        border-bottom: 0;
        border-left: 0.3em solid transparent;
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    /* Ensure dropdown buttons have minimum dimensions and proper styling */
    .btn.btn-sm.btn-light.dropdown-toggle {
        min-width: 34px;
        min-height: 34px;
        padding: 0.25rem 0.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: #f8f9fa;
    }
    
    .btn.btn-sm.btn-light.dropdown-toggle:hover {
        background: #e9ecef;
    }
    
    /* Improve dropdown menu styling */
    .dropdown-menu {
        padding: 0.5rem 0;
        min-width: 10rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        border: none;
    }
    
    .dropdown-item {
        padding: 0.6rem 1.5rem;
        font-size: 0.95rem;
    }
    
    .dropdown-item:hover {
        background-color: #f8f9fa;
    }
    
    /* Animation for updated balance */
    @keyframes balanceUpdate {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .balance-updated {
        animation: balanceUpdate 0.5s ease;
    }
    
    /* Loading overlay */
    #transactions-loading-overlay {
        transition: opacity 0.3s ease;
    }
    
    /* Modal styling improvements */
    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
        padding: 1.2rem 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-footer {
        padding: 1.2rem 1.5rem;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    /* Form styling */
    .form-control, .form-select {
        border-radius: 8px;
        padding: 0.6rem 1rem;
        border: 1px solid rgba(0, 0, 0, 0.15);
        transition: all 0.2s ease;
    }
    
    .form-control:focus, .form-select:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.2);
        border-color: #0d6efd;
    }
    
    .form-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    /* Transaction amount styling */
    .text-success.fw-bold, .text-danger.fw-bold {
        font-size: 1.05rem;
    }
    
    /* Fix modal display issues */
    .modal {
        z-index: 1050;
    }
    
    .modal-backdrop {
        z-index: 1040;
    }
    
    .modal-open {
        overflow: hidden;
    }
    
    .modal-open .modal {
        overflow-x: hidden;
        overflow-y: auto;
    }
    
    /* Ensure modals are properly displayed */
    #transactionModal, #deleteModal {
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    /* Fix the issue with screen going black */
    body.modal-open {
        padding-right: 0 !important;
    }
    
    /* Ensure content is visible */
    .modal-content {
        background-color: #fff;
        z-index: 1051;
    }
    
    /* Toast notification styling */
    .toast-container {
        z-index: 1080 !important;
    }
    
    .toast {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        margin-bottom: 0.75rem;
        width: 350px;
        max-width: 90vw;
    }
    
    .toast-header {
        border-bottom: none;
        padding: 0.75rem 1rem;
    }
    
    .toast-body {
        padding: 0.75rem 1rem;
        opacity: 0.9;
    }
    
    /* Toast animation */
    @keyframes toastFadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes toastFadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(20px); }
    }
    
    .toast.show {
        animation: toastFadeIn 0.3s ease forwards;
    }
    
    .toast.hide {
        animation: toastFadeOut 0.3s ease forwards;
    }
</style>
{% endblock %}

{% block content %}
<header class="page-header mb-4 d-flex justify-content-between align-items-center">
    <h1 class="h2 mb-0"><i class="bi bi-calendar-check me-2"></i>Transactions</h1>
    <div class="actions">
        <button type="button" class="btn btn-success" id="add-income-btn">
            <i class="bi bi-plus-circle me-1"></i> Add Income
        </button>
        <button type="button" class="btn btn-danger ms-2" id="add-expense-btn">
            <i class="bi bi-dash-circle me-1"></i> Add Expense
        </button>
    </div>
</header>

<!-- Quick Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body d-flex align-items-center">
                <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3" style="width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-arrow-up-circle text-success fs-4"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Total Income</h6>
                    <h5 class="mb-0">â‚±{{ total_income|default:'0.00'|floatformat:2 }}</h5>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body d-flex align-items-center">
                <div class="rounded-circle bg-danger bg-opacity-10 p-3 me-3" style="width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-arrow-down-circle text-danger fs-4"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Total Expenses</h6>
                    <h5 class="mb-0">â‚±{{ total_expenses|default:'0.00'|floatformat:2 }}</h5>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body d-flex align-items-center">
                <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3" style="width: 56px; height: 56px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-wallet2 text-primary fs-4"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-1">Net Balance</h6>
                    <h5 class="mb-0 {% if total_balance >= 0 %}text-success{% else %}text-danger{% endif %}">
                        â‚±{{ total_balance|default:'0.00'|floatformat:2 }}
                    </h5>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Filter Container -->
    <div class="col-md-3">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0"><i class="bi bi-funnel me-2"></i>Filter</h2>
            </div>
            <!-- Transaction Type Filters -->
            <div class="card-body py-3 border-bottom">
                <div class="btn-group w-100" role="group" aria-label="Transaction Type Filters">
                    <button type="button" class="btn btn-sm btn-outline-secondary active" id="filter-all" data-filter="all">All</button>
                    <button type="button" class="btn btn-sm btn-outline-success" id="filter-income" data-filter="income">Income</button>
                    <button type="button" class="btn btn-sm btn-outline-danger" id="filter-expense" data-filter="expense">Expenses</button>
                </div>
            </div>
            <div class="card-body">
                <form id="transaction-filter-form">
                    <div class="mb-3">
                        <label for="category-filter" class="form-label">
                            <i class="bi bi-tags me-1"></i>Category
                        </label>
                        <select id="category-filter" class="form-select" tabindex="1">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" data-icon="{{ category.icon }}" data-type="{{ category.type }}" data-is-category="true">{{ category.name }}</option>
                                {% for subcategory in category.subcategories.all %}
                                <option value="{{ subcategory.id }}" data-icon="{{ subcategory.icon|default:category.icon }}" data-type="{{ category.type }}" data-parent-category="{{ category.id }}" data-subcategory-id="{{ subcategory.id }}">{{ subcategory.name }}</option>
                                {% endfor %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="from-to-filter" class="form-label">
                            <i class="bi bi-search me-1"></i>Search
                        </label>
                        <div class="input-group">
                            <input type="text" id="from-to-filter" class="form-control" placeholder="Search by title or notes">
                            <button class="btn btn-outline-secondary d-none" type="button" id="clear-search-btn">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <button type="button" id="clear-filters-btn" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset All Filters
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Transactions List -->
    <div class="col-md-9">
        <div class="card border-0 shadow-sm mb-4">
            <!-- Month Navigation -->
            <div class="card-header d-flex justify-content-between align-items-center">
                <button type="button" id="prev-month-btn" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <div class="text-center">
                    <h3 id="current-month" class="h5 mb-0">{{ current_month_name }} {{ current_year }}</h3>
                    <div id="current-month-data" data-month="{{ current_month }}" data-year="{{ current_year }}" class="d-none"></div>
                </div>
                <button type="button" id="next-month-btn" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            
            <!-- Transactions Summary -->
            <div class="card-body pb-0">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="p-2 bg-light rounded-3">
                        <span class="fw-bold">Transactions: </span>
                        <span id="transaction-count" class="badge bg-secondary rounded-pill">{{ transactions.count }}</span>
                    </div>
                    <div class="p-2 bg-light rounded-3">
                        <span class="fw-bold">Total: </span>
                        <span id="transaction-total" class="badge {% if total_balance >= 0 %}bg-success{% else %}bg-danger{% endif %} rounded-pill">
                            â‚±{{ total_balance|floatformat:2 }}
                        </span>
                    </div>
                </div>
                <!-- Add select all option -->
                <div class="mt-2 d-flex justify-content-between align-items-center border-bottom pb-3">
                    <div class="d-flex align-items-center">
                        <div class="custom-checkbox me-2" style="min-width: 24px;">
                            <input class="select-all-transactions" type="checkbox" id="select-all-transactions">
                            <label class="custom-checkbox-label" for="select-all-transactions"></label>
                        </div>
                        <label class="form-check-label ms-1" for="select-all-transactions">
                            Select All
                        </label>
                    </div>
                    <div class="batch-actions invisible">
                        <button class="btn btn-sm btn-danger batch-delete" type="button">
                            <i class="bi bi-trash me-1"></i>Delete Selected (<span class="selected-count">0</span>)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Transactions List -->
            <div class="list-group list-group-flush">
                {% if transactions %}
                    {% for transaction in transactions %}
                    <div class="list-group-item d-flex justify-content-between align-items-center transaction-item position-relative">
                        <div class="d-flex align-items-center">
                            <div class="custom-checkbox me-3">
                                <input class="transaction-check" type="checkbox" value="{{ transaction.id }}" id="check-{{ transaction.id }}">
                                <label class="custom-checkbox-label" for="check-{{ transaction.id }}"></label>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="transaction-icon me-3">
                                    <span class="icon-wrapper bg-{% if transaction.type == 'income' %}success{% else %}danger{% endif %} p-2">
                                        <i class="{% if transaction.subcategory %}{{ transaction.subcategory.icon }}{% elif transaction.category %}{{ transaction.category.icon }}{% else %}bi bi-tag{% endif %} text-white fs-5"></i>
                                    </span>
                                </div>
                                <div>
                                    <div class="fw-bold">{{ transaction.title }}</div>
                                    <small class="text-muted d-flex align-items-center">
                                        <i class="bi bi-tag-fill me-1 opacity-50"></i>
                                        {% if transaction.subcategory %}{{ transaction.subcategory.name }}{% elif transaction.category %}{{ transaction.category.name }}{% else %}Uncategorized{% endif %}
                                        {% if transaction.notes %}
                                        <span class="mx-1">â€¢</span>
                                        <i class="bi bi-journal-text me-1 opacity-50"></i>{{ transaction.notes }}
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="text-end me-3">
                                <div class="text-{% if transaction.type == 'income' %}success{% else %}danger{% endif %} fw-bold">
                                    {% if transaction.type == 'income' %}+{% else %}-{% endif %}â‚±{{ transaction.amount|floatformat:2 }}
                                </div>
                                <small class="text-muted d-flex align-items-center justify-content-end">
                                    <i class="bi bi-calendar-date me-1"></i>{{ transaction.date|date:"m/d/Y" }}
                                </small>
                            </div>
                            <!-- Transaction Actions -->
                            <div class="dropdown ms-3">
                                <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="dropdownMenuButton-{{ transaction.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-three-dots-vertical"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="dropdownMenuButton-{{ transaction.id }}">
                                    <li><a class="dropdown-item edit-transaction" href="#" data-id="{{ transaction.id }}"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                    <li><a class="dropdown-item duplicate-transaction" href="#" data-id="{{ transaction.id }}"><i class="bi bi-copy me-2"></i>Duplicate</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item delete-transaction text-danger" href="#" data-id="{{ transaction.id }}"><i class="bi bi-trash me-2"></i>Delete</a></li>
                                </ul>
                            </div>
                        </div>
                        <!-- Color indicator bar -->
                        <div class="position-absolute top-0 bottom-0 end-0 transaction-indicator {% if transaction.type == 'income' %}bg-success{% else %}bg-danger{% endif %}" style="width: 4px;"></div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="list-group-item py-5 text-center">
                        <i class="bi bi-inbox fs-1 text-muted mb-3 d-block"></i>
                        <p class="mb-0 text-muted">No transactions found for this period</p>
                        <button type="button" class="btn btn-outline-primary mt-3" id="{% if selected_type == 'income' %}add-income-btn{% else %}add-expense-btn{% endif %}">
                            <i class="bi bi-plus-circle me-1"></i> Add {% if selected_type == 'income' %}Income{% else %}Expense{% endif %}
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Transaction Modal (for Add/Edit) -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">Add Transaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="transaction-form" class="needs-validation" novalidate>
                    {% csrf_token %}
                    <input type="hidden" id="transaction-id" name="transaction_id" value="">
                    <input type="hidden" id="transaction-type" name="type" value="expense">
                    
                    <div class="mb-3">
                        <label for="transaction-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="transaction-title" name="title" required>
                        <div class="invalid-feedback">
                            Please provide a title for this transaction.
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="transaction-amount" class="form-label">Amount</label>
                            <div class="input-group has-validation">
                                <span class="input-group-text" id="currency-symbol">â‚±</span>
                                <input type="number" class="form-control" id="transaction-amount" name="amount" step="0.01" min="0.01" placeholder="0.00" required>
                                <div class="invalid-feedback">
                                    Please enter a valid amount greater than 0.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="transaction-date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="transaction-date" name="date" required>
                            <div class="invalid-feedback">
                                Please select a valid date.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="transaction-time" class="form-label">Time</label>
                            <input type="time" class="form-control" id="transaction-time" name="time" required>
                            <div class="invalid-feedback">
                                Please select a valid time.
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-account" class="form-label">Account</label>
                        <div class="input-group has-validation">
                            <select class="form-select account-select w-100" id="transaction-account" name="transaction_account" style="height: 46px;" required>
                                <option value="" data-icon="bi-bank">Choose your account</option>
                                {% for account in accounts %}
                                <option value="{{ account.id }}" data-account-type="{{ account.get_account_type }}" 
                                        data-icon="{% if account.get_account_type == 'credit' %}bi-credit-card{% elif account.get_account_type == 'wallet' %}bi-wallet2{% else %}bi-piggy-bank{% endif %}">
                                    {{ account.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                Please select an account.
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="transaction-category" class="form-label">Category</label>
                        <div class="input-group has-validation">
                            <select class="form-select category-select w-100" id="transaction-category" name="category" style="height: 46px;" required>
                                <option value="" data-icon="bi-bookmark">Choose a category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" data-icon="{{ category.icon }}" data-type="{{ category.type }}" data-is-category="true">{{ category.name }}</option>
                                    {% for subcategory in category.subcategories.all %}
                                    <option value="{{ subcategory.id }}" data-icon="{{ subcategory.icon|default:category.icon }}" data-type="{{ category.type }}" data-parent-category="{{ category.id }}" data-subcategory-id="{{ subcategory.id }}">{{ subcategory.name }}</option>
                                    {% endfor %}
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                Please select a category.
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="transaction-subcategory" name="subcategory" value="">
                    
                    <div class="mb-3">
                        <label for="transaction-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="transaction-notes" name="notes" rows="2" placeholder="Add notes about this transaction"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-transaction-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="delete-confirmation-message">Are you sure you want to delete this transaction? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Emergency fix button for modal issues - Commented out -->
<!--
<button id="emergency-fix" type="button" onclick="fixModalIssues()">
    Screen stuck? Click to fix!
</button>
-->
{% endblock %}

{% block extra_scripts %}
<!-- Ensure Bootstrap JS is properly loaded -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Other scripts -->
<script src="{% static 'js/category_dropdown.js' %}"></script>
<script src="{% static 'js/transaction.js' %}"></script>
<script src="{% static 'js/filter_category_dropdown.js' %}"></script>
<script src="{% static 'js/transaction_list.js' %}"></script>
<!-- Modal initialization script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Checking bootstrap availability:', typeof bootstrap !== 'undefined');
        console.log('Checking bootstrap.Modal availability:', 
                  typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined');
        console.log('DeleteModal element exists:', document.getElementById('deleteModal') !== null);
        
        // Advanced modal management to prevent black screen issues
        function setupModalManagement() {
            // Get all modals on the page
            const modals = document.querySelectorAll('.modal');
            
            // For each modal, ensure it has proper event listeners
            modals.forEach(modal => {
                // Click outside modal to close
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        console.log('Clicked outside modal content, closing modal');
                        closeModalProperly(modal);
                    }
                });
                
                // Close button click handler
                const closeButtons = modal.querySelectorAll('[data-bs-dismiss="modal"], .btn-close, .btn-secondary');
                closeButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        console.log('Modal close button clicked');
                        closeModalProperly(modal);
                    });
                });
            });
            
            // Escape key to close any visible modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' || e.keyCode === 27) {
                    const visibleModal = document.querySelector('.modal.show');
                    if (visibleModal) {
                        console.log('Escape key pressed, closing modal');
                        closeModalProperly(visibleModal);
                    }
                }
            });
            
            // Click on backdrop to close modal
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal-backdrop')) {
                    console.log('Backdrop clicked, closing modals');
                    document.querySelectorAll('.modal.show').forEach(modal => {
                        closeModalProperly(modal);
                    });
                }
            });
            
            // Function to properly close a modal
            function closeModalProperly(modal) {
                // Try bootstrap first
                try {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const bsModal = bootstrap.Modal.getInstance(modal);
                        if (bsModal) {
                            bsModal.hide();
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('Error using Bootstrap to close modal:', err);
                }
                
                // Fallback to manual closing
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                
                // Remove backdrop manually
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                
                // Reset body
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }
            
            // Detect when a modal backdrop is added to the DOM
            const bodyObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.classList && node.classList.contains('modal-backdrop')) {
                                console.log('Modal backdrop detected');
                                // Check if any modal is actually visible
                                setTimeout(function() {
                                    const visibleModals = document.querySelectorAll('.modal.show');
                                    if (visibleModals.length === 0) {
                                        console.log('No visible modals, removing orphaned backdrop');
                                        node.remove();
                                        document.body.classList.remove('modal-open');
                                        document.body.style.overflow = '';
                                        document.body.style.paddingRight = '';
                                    }
                                }, 100);
                            }
                        });
                    }
                });
            });
            
            // Start observing the body for added modal backdrops
            bodyObserver.observe(document.body, {
                childList: true,
                subtree: false
            });
        }
        
        // Run modal setup
        setupModalManagement();
        
        // Function to clean up any stray modal elements
        function cleanupModalArtifacts() {
            // Remove any stuck modal backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            if (backdrops.length > 0) {
                console.log('Cleaning up', backdrops.length, 'modal backdrops');
                backdrops.forEach(backdrop => backdrop.remove());
            }
            
            // Ensure body doesn't have modal-open class if no modals are visible
            const visibleModals = document.querySelectorAll('.modal.show');
            if (visibleModals.length === 0 && document.body.classList.contains('modal-open')) {
                console.log('Removing modal-open class from body');
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }
        }
        
        // Run cleanup on page load
        cleanupModalArtifacts();
        
        // Override loadTransactionsForMonth to clean up after refresh
        if (typeof window.loadTransactionsForMonth === 'function') {
            const originalLoadTransactions = window.loadTransactionsForMonth;
            window.loadTransactionsForMonth = function(...args) {
                // Clean up before loading new transactions
                cleanupModalArtifacts();
                
                // Call the original function
                const result = originalLoadTransactions.apply(this, args);
                
                // Clean up after a short delay to ensure any new modals are properly handled
                setTimeout(() => {
                    cleanupModalArtifacts();
                    
                    // After cleaning up, reattach event handlers
                    if (typeof window.attachDeleteEventHandlers === 'function') {
                        window.attachDeleteEventHandlers();
                    }
                }, 200);
                
                return result;
            };
        }
        
        // Initialize all dropdowns
        function initializeDropdowns() {
            console.log('Initializing dropdowns');
            
            // First, try to initialize using Bootstrap's Dropdown
            document.querySelectorAll('.dropdown-toggle').forEach(function(dropdownToggle) {
                try {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Dropdown) {
                        new bootstrap.Dropdown(dropdownToggle);
                    }
                } catch (err) {
                    console.error('Error initializing dropdown:', err);
                }
                
                // Also add a direct click handler as a fallback
                dropdownToggle.removeEventListener('click', toggleDropdownMenu);
                dropdownToggle.addEventListener('click', toggleDropdownMenu);
            });
        }
        
        // Function to manually toggle dropdown menu visibility
        function toggleDropdownMenu(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const dropdownMenu = this.nextElementSibling;
            if (!dropdownMenu || !dropdownMenu.classList.contains('dropdown-menu')) {
                return;
            }
            
            // Toggle dropdown visibility
            const isCurrentlyVisible = dropdownMenu.classList.contains('show');
            
            // First close all other open dropdowns
            document.querySelectorAll('.dropdown-menu.show').forEach(function(menu) {
                if (menu !== dropdownMenu) {
                    menu.classList.remove('show');
                }
            });
            
            // Toggle this dropdown
            if (isCurrentlyVisible) {
                dropdownMenu.classList.remove('show');
            } else {
                dropdownMenu.classList.add('show');
                dropdownMenu.style.position = 'absolute';
                dropdownMenu.style.inset = '0px 0px auto auto';
                dropdownMenu.style.margin = '0px';
                dropdownMenu.style.transform = 'translate(-8px, 40px)';
            }
            
            // Close dropdown when clicking outside
            if (!isCurrentlyVisible) {
                const closeDropdownHandler = function(evt) {
                    if (!dropdownMenu.contains(evt.target) && evt.target !== e.target) {
                        dropdownMenu.classList.remove('show');
                        document.removeEventListener('click', closeDropdownHandler);
                    }
                };
                
                // Add event listener with a small delay to avoid immediate triggering
                setTimeout(function() {
                    document.addEventListener('click', closeDropdownHandler);
                }, 10);
            }
        }
        
        // Run initial dropdown initialization
        initializeDropdowns();
        
        // Force immediate styling fix on all dropdowns
        function fixDropdownButtons() {
            document.querySelectorAll('.btn.btn-sm.btn-light.dropdown-toggle').forEach(function(button) {
                // Ensure button has correct styling
                button.style.minWidth = '30px';
                button.style.minHeight = '30px';
                button.style.padding = '0.25rem 0.5rem';
                button.style.display = 'inline-flex';
                button.style.alignItems = 'center';
                button.style.justifyContent = 'center';
                
                // Force the caret to be visible
                if (!button.querySelector('.caret') && !button.innerHTML.trim()) {
                    const caret = document.createElement('span');
                    caret.className = 'caret';
                    button.appendChild(caret);
                }
            });
        }
        
        // Run the fix immediately
        fixDropdownButtons();
        
        // Re-run after any transactions list updates
        const transactionListElement = document.querySelector('.list-group-flush');
        if (transactionListElement) {
            transactionListElement.addEventListener('DOMNodeInserted', function(event) {
                // Wait a tiny bit to ensure the DOM is fully updated
                setTimeout(fixDropdownButtons, 10);
            });
            
            // Set up mutation observer for dropdown initialization
            const observer = new MutationObserver(function(mutations) {
                setTimeout(function() {
                initializeDropdowns();
                    fixDropdownButtons();
                }, 10);
            });
            
            observer.observe(transactionListElement, { childList: true });
        }
        
        // Override updateTransactionList function if it gets defined later
        const originalUpdateTransactionList = window.updateTransactionList;
        if (originalUpdateTransactionList) {
            window.updateTransactionList = function(...args) {
                const result = originalUpdateTransactionList.apply(this, args);
                setTimeout(function() {
                    initializeDropdowns();
                    fixDropdownButtons();
                }, 10);
                return result;
            };
        }
        
        // Global function to show the delete modal directly
        window.showDeleteConfirmationModal = function(title, message, confirmText, confirmCallback) {
            const deleteModal = document.getElementById('deleteModal');
            const deleteModalLabel = document.getElementById('deleteModalLabel');
            const deleteConfirmationMessage = document.getElementById('delete-confirmation-message');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            
            if (!deleteModal || !deleteModalLabel || !deleteConfirmationMessage || !confirmDeleteBtn) {
                console.error('Delete modal elements not found');
                alert('Error showing confirmation dialog');
                return;
            }
            
            // Clean up any existing backdrops before showing a new modal
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());
            
            // Update modal content
            deleteModalLabel.textContent = title || 'Confirm Delete';
            deleteConfirmationMessage.innerHTML = message || 'Are you sure you want to delete this item?';
            confirmDeleteBtn.textContent = confirmText || 'Delete';
            confirmDeleteBtn.classList.remove('btn-primary');
            confirmDeleteBtn.classList.add('btn-danger');
            
            // Show the modal using Bootstrap if available, otherwise fallback to direct DOM manipulation
            try {
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    const bsModal = new bootstrap.Modal(deleteModal);
                    bsModal.show();
                    
                    // Set the confirm button handler
                    confirmDeleteBtn.onclick = function() {
                        if (typeof confirmCallback === 'function') {
                            confirmCallback();
                        }
                        bsModal.hide();
                    };
                    
                    // Set event handler to clean up when the modal is hidden
                    deleteModal.addEventListener('hidden.bs.modal', function() {
                        cleanupModalState();
                    }, { once: true });
                    
                    return;
                }
            } catch (err) {
                console.error('Error using Bootstrap Modal:', err);
                // Continue with fallback
            }
            
            // Fallback to direct DOM manipulation if Bootstrap failed
            console.log('Using direct DOM manipulation for modal');
            
            // Show the modal using direct DOM API
            deleteModal.classList.add('show');
            deleteModal.style.display = 'block';
            document.body.classList.add('modal-open');
            
            // Create backdrop manually
            const backdrop = document.createElement('div');
            backdrop.classList.add('modal-backdrop', 'show');
            document.body.appendChild(backdrop);
            
            // Set the confirm button handler
            confirmDeleteBtn.onclick = function() {
                if (typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                
                // Hide the modal
                hideDeleteConfirmationModal();
            };
            
            // Set cancel button handler
            const cancelBtn = deleteModal.querySelector('.btn-secondary');
            if (cancelBtn) {
                cancelBtn.onclick = hideDeleteConfirmationModal;
            }
            
            // Also capture click on X button
            const closeBtn = deleteModal.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.onclick = hideDeleteConfirmationModal;
            }
            
            // Also capture click outside modal
            deleteModal.onclick = function(event) {
                if (event.target === deleteModal) {
                    hideDeleteConfirmationModal();
                }
            };
            
            // Escape key handler
            const escHandler = function(e) {
                if (e.key === 'Escape' || e.keyCode === 27) {
                    hideDeleteConfirmationModal();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            function hideDeleteConfirmationModal() {
                // Hide the modal
                deleteModal.classList.remove('show');
                deleteModal.style.display = 'none';
                
                // Remove the backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                
                // Reset body state
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                
                // Clean up event handlers
                cleanupModalState();
            }
            
            function cleanupModalState() {
                // Reset the modal content and events
                if (cancelBtn) cancelBtn.onclick = null;
                if (closeBtn) closeBtn.onclick = null;
                deleteModal.onclick = null;
                confirmDeleteBtn.onclick = null;
                
                // Remove the escape key handler
                document.removeEventListener('keydown', escHandler);
            }
        };
        
        // Function to attach delete event handlers to transaction items
        window.attachDeleteEventHandlers = function() {
            console.log('Attaching delete event handlers to transaction items');
            
            // Direct event listeners for delete transaction links
            document.querySelectorAll('.delete-transaction').forEach(link => {
                // Remove existing listener first to prevent duplicates
                link.removeEventListener('click', handleDeleteClick);
                // Add the new listener
                link.addEventListener('click', handleDeleteClick);
            });
            
            // Direct event listener for batch delete button
            const batchDeleteBtn = document.querySelector('.batch-delete');
            if (batchDeleteBtn) {
                // Remove existing listener first
                batchDeleteBtn.removeEventListener('click', handleBatchDeleteClick);
                // Add the new listener
                batchDeleteBtn.addEventListener('click', handleBatchDeleteClick);
            }
        };
        
        // Handler function for delete transaction clicks
        function handleDeleteClick(e) {
            e.preventDefault();
            const transactionId = this.getAttribute('data-id');
            
            // Find the transaction title
            const transactionItem = this.closest('.transaction-item');
            const transactionTitle = transactionItem ? transactionItem.querySelector('.fw-bold').textContent : 'this transaction';
            
            // Show confirmation dialog
            window.showDeleteConfirmationModal(
                'Confirm Delete Transaction',
                `<p>Are you sure you want to delete the transaction <strong>"${transactionTitle}"</strong>?</p>
                 <div class="alert alert-warning">
                     <i class="bi bi-exclamation-triangle-fill me-2"></i>
                     This action cannot be undone.
                 </div>`,
                'Delete Transaction',
                function() {
                    // Send delete request
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    fetch(`/finances/transactions/api/${transactionId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Reset selection counter and hide batch actions
                            document.querySelector('.selected-count').textContent = '0';
                            document.querySelector('.batch-actions').classList.add('invisible');
                            document.getElementById('select-all-transactions').checked = false;
                            
                            // Reload transactions
                            const urlParams = new URLSearchParams(window.location.search);
                            if (typeof loadTransactionsForMonth === 'function') {
                                loadTransactionsForMonth(urlParams.toString());
                            } else {
                                // Fallback to page reload
                                window.location.reload();
                            }
                            
                            if (typeof showToast === 'function') {
                                showToast('Success', 'Transaction deleted successfully', 'success');
                            }
                        } else {
                            throw new Error(data.error || 'Unknown error');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting transaction:', error);
                        if (typeof showToast === 'function') {
                            showToast('Error', 'Failed to delete transaction: ' + error.message, 'danger');
                        } else {
                            alert('Error deleting transaction: ' + error.message);
                        }
                    });
                }
            );
        }
        
        // Handler function for batch delete clicks
        function handleBatchDeleteClick() {
            const checkedBoxes = document.querySelectorAll('.transaction-check:checked');
            if (checkedBoxes.length === 0) return;
            
            const transactionIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
            const count = transactionIds.length;
            
            // Show confirmation dialog
            window.showDeleteConfirmationModal(
                'Confirm Batch Delete',
                `<p>Are you sure you want to delete ${count} selected transaction(s)?</p>
                 <div class="alert alert-warning">
                     <i class="bi bi-exclamation-triangle-fill me-2"></i>
                     This action cannot be undone.
                 </div>`,
                'Delete Selected Transactions',
                function() {
                    // Send batch delete request
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    fetch('/finances/transactions/api/batch-delete/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ transaction_ids: transactionIds })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Reset selection counter and hide batch actions
                            document.querySelector('.selected-count').textContent = '0';
                            document.querySelector('.batch-actions').classList.add('invisible');
                            document.getElementById('select-all-transactions').checked = false;
                            
                            // Reload transactions
                            const urlParams = new URLSearchParams(window.location.search);
                            if (typeof loadTransactionsForMonth === 'function') {
                                loadTransactionsForMonth(urlParams.toString());
                            } else {
                                // Fallback to page reload
                                window.location.reload();
                            }
                            
                            if (typeof showToast === 'function') {
                                showToast('Success', `Successfully deleted ${count} transaction(s)`, 'success');
                            }
                        } else {
                            throw new Error(data.error || 'Unknown error');
                        }
                    })
                    .catch(error => {
                        console.error('Error batch deleting transactions:', error);
                        if (typeof showToast === 'function') {
                            showToast('Error', 'Failed to delete transactions: ' + error.message, 'danger');
                        } else {
                            alert('Error deleting transactions: ' + error.message);
                        }
                    });
                }
            );
        }
        
        // If test button exists, add a direct handler - Commented out
        /*
        const testBtn = document.getElementById('test-delete-modal');
        if (testBtn) {
            testBtn.addEventListener('click', function() {
                window.showDeleteConfirmationModal(
                    'Test Delete Modal',
                    '<p>This is a test of the delete modal functionality.</p>' +
                    '<div class="alert alert-warning">' +
                    '<i class="bi bi-exclamation-triangle-fill me-2"></i>' +
                    'This is just a test, no action will be taken.' +
                    '</div>',
                    'Test Button',
                    function() {
                        alert('Test button clicked!');
                    }
                );
            });
        }
        */
        
        // Initial attachment of event handlers
        window.attachDeleteEventHandlers();
        
        // Add a mutation observer to watch for changes to the transaction list
        // This ensures event handlers are reattached when the transaction list is updated
        const transactionListForHandlers = document.querySelector('.list-group-flush');
        if (transactionListForHandlers) {
            const observer = new MutationObserver(function(mutations) {
                window.attachDeleteEventHandlers();
            });
            
            observer.observe(transactionListForHandlers, { childList: true, subtree: true });
        }
        
        // Add emergency fix function - Commented out
        /*
        window.fixModalIssues = function() {
            console.log('Emergency fix executed');
            
            // Remove all modal backdrops
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            
            // Hide all modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
                modal.classList.remove('show');
                modal.setAttribute('aria-hidden', 'true');
            });
            
            // Reset body styles
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            
            return false; // Prevent default
        };
        
        // Add keyboard shortcut (Escape key) to fix modal issues
        document.addEventListener('keydown', function(e) {
            // ESC key
            if (e.key === 'Escape' || e.keyCode === 27) {
                // Only execute if body has modal-open class
                if (document.body.classList.contains('modal-open')) {
                    window.fixModalIssues();
                }
            }
        });
        */
    });
</script>
{% endblock %} 