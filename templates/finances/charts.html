{% extends 'base.html' %}
{% load static %}

{% block title %}Charts - Budget Tracker{% endblock %}
{% block navbar_title %}Charts{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
<style>
    .charts-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
        margin-bottom: 20px;
    }

    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        padding: 12px 24px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .nav-tabs .nav-link:hover {
        color: #0d6efd;
        border: none;
    }

    .nav-tabs .nav-link.active {
        color: #0d6efd;
        border: none;
        border-bottom: 2px solid #0d6efd;
        margin-bottom: -2px;
    }

    .tab-content {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .chart-section {
        min-height: 400px;
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .chart-section h2 {
        margin-bottom: 20px;
        color: #333;
        font-size: 24px;
        width: 100%;
    }

    .chart-section canvas {
        max-width: 500px;
        max-height: 500px;
        width: 100% !important;
        height: auto !important;
        margin: 0 auto;
    }

    .chart-filters {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        width: 100%;
    }

    .filter-group {
        margin-bottom: 15px;
    }

    .filter-group label {
        font-weight: 500;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="charts-container">
    <ul class="nav nav-tabs" id="chartsTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab" aria-controls="categories" aria-selected="true">
                <i class="bi bi-pie-chart me-2"></i>Categories
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="time-tab" data-bs-toggle="tab" data-bs-target="#time" type="button" role="tab" aria-controls="time" aria-selected="false">
                <i class="bi bi-graph-up me-2"></i>Time
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="future-tab" data-bs-toggle="tab" data-bs-target="#future" type="button" role="tab" aria-controls="future" aria-selected="false">
                <i class="bi bi-bar-chart-line me-2"></i>Future
            </button>
        </li>
    </ul>

    <div class="tab-content" id="chartsTabContent">
        <!-- Categories Chart Tab -->
        <div class="tab-pane fade show active" id="categories" role="tabpanel" aria-labelledby="categories-tab">
            <div class="chart-filters">
                <div class="row">
                    <div class="col-md-4">
                        <div class="filter-group">
                            <label for="categories-time-range">Time Range</label>
                            <select class="form-select" id="categories-time-range">
                                <option value="week">Last Week</option>
                                <option value="month" selected>Last Month</option>
                                <option value="year">Last Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="filter-group">
                            <label for="categories-type">Chart Type</label>
                            <select class="form-select" id="categories-type">
                                <option value="pie" selected>Pie Chart</option>
                                <option value="bar">Bar Chart</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chart-section">
                <h2>Categories Chart</h2>
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- Time Chart Tab -->
        <div class="tab-pane fade" id="time" role="tabpanel" aria-labelledby="time-tab">
            <div class="chart-filters">
                <div class="row">
                    <div class="col-md-4">
                        <div class="filter-group">
                            <label for="time-range">Time Range</label>
                            <select class="form-select" id="time-range">
                                <option value="week">Last Week</option>
                                <option value="month" selected>Last Month</option>
                                <option value="year">Last Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="filter-group">
                            <label for="time-interval">Interval</label>
                            <select class="form-select" id="time-interval">
                                <option value="day" selected>Daily</option>
                                <option value="week">Weekly</option>
                                <option value="month">Monthly</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chart-section">
                <h2>Time Chart</h2>
                <canvas id="timeChart"></canvas>
            </div>
        </div>

        <!-- Future Chart Tab -->
        <div class="tab-pane fade" id="future" role="tabpanel" aria-labelledby="future-tab">
            <div class="chart-filters">
                <div class="row">
                    <div class="col-md-4">
                        <div class="filter-group">
                            <label for="future-period">Forecast Period</label>
                            <select class="form-select" id="future-period">
                                <option value="month" selected>Next Month</option>
                                <option value="quarter">Next Quarter</option>
                                <option value="year">Next Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="filter-group">
                            <label for="future-type">Chart Type</label>
                            <select class="form-select" id="future-type">
                                <option value="line" selected>Line Chart</option>
                                <option value="bar">Bar Chart</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chart-section">
                <h2>Future Chart</h2>
                <canvas id="futureChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Parse JSON data from Django template
    const categoryData = JSON.parse('{{ category_data|escapejs }}');
    const timeData = JSON.parse('{{ time_data|escapejs }}');
    const futureData = JSON.parse('{{ future_data|escapejs }}');

    // Colors for charts (matching accounts.html)
    const CHART_COLORS = [
        'rgba(255, 99, 132, 0.6)',
        'rgba(54, 162, 235, 0.6)',
        'rgba(75, 192, 192, 0.6)'
    ];
    const CHART_BORDER_COLORS = [
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(75, 192, 192, 1)'
    ];

    // Initialize charts
    let categoryChart = null;
    let timeChart = null;
    let futureChart = null;

    // Initialize the first tab's chart
    initializeCategoryChart();

    // Add event listeners for tab changes
    document.getElementById('categories-tab').addEventListener('click', initializeCategoryChart);
    document.getElementById('time-tab').addEventListener('click', initializeTimeChart);
    document.getElementById('future-tab').addEventListener('click', initializeFutureChart);

    // Add event listeners for filter changes
    document.getElementById('categories-time-range').addEventListener('change', updateCategoryChart);
    document.getElementById('categories-type').addEventListener('change', updateCategoryChart);
    document.getElementById('time-range').addEventListener('change', updateTimeChart);
    document.getElementById('time-interval').addEventListener('change', updateTimeChart);
    document.getElementById('future-period').addEventListener('change', updateFutureChart);
    document.getElementById('future-type').addEventListener('change', updateFutureChart);

    function initializeCategoryChart() {
        updateCategoryChart();
    }

    function initializeTimeChart() {
        updateTimeChart();
    }

    function initializeFutureChart() {
        updateFutureChart();
    }

    function updateCategoryChart() {
        const chartType = document.getElementById('categories-type').value;
        
        // Destroy existing chart if it exists
        if (categoryChart) {
            categoryChart.destroy();
        }
        
        // Create new chart based on selected type
        if (chartType === 'pie') {
            categoryChart = createPieChart('categoryChart', categoryData);
        } else {
            categoryChart = createBarChart('categoryChart', categoryData);
        }
    }

    function updateTimeChart() {
        // Destroy existing chart if it exists
        if (timeChart) {
            timeChart.destroy();
        }
        
        // Create new chart
        timeChart = createTimeChart('timeChart', timeData);
    }

    function updateFutureChart() {
        const chartType = document.getElementById('future-type').value;
        
        // Destroy existing chart if it exists
        if (futureChart) {
            futureChart.destroy();
        }
        
        // Create new chart based on selected type
        futureChart = createFutureChart('futureChart', futureData, chartType);
    }

    function createPieChart(elementId, data) {
        const ctx = document.getElementById(elementId).getContext('2d');
        
        if (!data || data.length === 0) {
            document.getElementById(elementId).parentNode.innerHTML = 
                '<div class="text-center p-5">' +
                '<p class="text-muted">No data available for this period.</p>' +
                '</div>';
            return null;
        }
        
        return new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(item => item.category),
                datasets: [{
                    data: data.map(item => item.amount),
                    backgroundColor: CHART_COLORS,
                    borderColor: CHART_BORDER_COLORS,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }

    function createBarChart(elementId, data) {
        const ctx = document.getElementById(elementId).getContext('2d');
        
        if (!data || data.length === 0) {
            document.getElementById(elementId).parentNode.innerHTML = 
                '<div class="text-center p-5">' +
                '<p class="text-muted">No data available for this period.</p>' +
                '</div>';
            return null;
        }
        
        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(item => item.category),
                datasets: [{
                    label: 'Amount',
                    data: data.map(item => item.amount),
                    backgroundColor: CHART_COLORS,
                    borderColor: CHART_BORDER_COLORS,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createTimeChart(elementId, data) {
        const ctx = document.getElementById(elementId).getContext('2d');
        
        if (!data || data.labels.length === 0) {
            document.getElementById(elementId).parentNode.innerHTML = 
                '<div class="text-center p-5">' +
                '<p class="text-muted">No data available for this period.</p>' +
                '</div>';
            return null;
        }
        
        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    {
                        label: 'Income',
                        data: data.income,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Expenses',
                        data: data.expenses,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function createFutureChart(elementId, data, type) {
        const ctx = document.getElementById(elementId).getContext('2d');
        
        if (!data || data.labels.length === 0) {
            document.getElementById(elementId).parentNode.innerHTML = 
                '<div class="text-center p-5">' +
                '<p class="text-muted">No data available for this period.</p>' +
                '</div>';
            return null;
        }
        
        return new Chart(ctx, {
            type: type,
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Projected Amount',
                    data: data.projected,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: type === 'bar' ? 'rgba(54, 162, 235, 0.6)' : 'rgba(54, 162, 235, 0.2)',
                    borderWidth: 2,
                    fill: type === 'line'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
</script>
{% endblock %} 