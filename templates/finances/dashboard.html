{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Budget Tracker{% endblock %}

{% block navbar_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
/* Dark mode styles for welcome text */
body.dark-mode .welcome-text {
    color: #e2e8f0 !important;
}

body.dark-mode .date-text {
    color: #a0aec0 !important;
}

.dashboard-grid .card {
    transition: all 0.25s ease-in-out;
    border-radius: 12px;
    overflow: hidden;
}

.dashboard-grid .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
}

.dashboard-grid .card-header {
    cursor: grab;
    background: linear-gradient(to right, rgba(67, 97, 238, 0.05), rgba(67, 97, 238, 0.1));
    border-bottom: 1px solid rgba(67, 97, 238, 0.1);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.8rem 1.25rem;
}

.dashboard-grid .card-header .fs-6 {
    margin: 0;
    font-weight: 600;
    color: var(--primary-color);
}

.dashboard-grid .card-header:active {
    cursor: grabbing;
    background-color: rgba(67, 97, 238, 0.15);
}

/* Improved text readability styles */
.card-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.account-type-label {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 0.3rem;
}

.value-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.amount-value {
    font-size: 1rem;
    font-weight: 600;
}

.total-amount {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.5px;
    padding: 0.25rem 0.4rem;
    border-radius: 6px;
    display: inline-block;
}

.income-text {
    color: var(--positive-color);
}

.expense-text {
    color: #d9534f;
}

.card-section {
    margin-bottom: 1.2rem;
}

.card-footer-section {
    padding-top: 0.8rem;
    border-top: 1px solid rgba(0, 0, 0, 0.08);
    margin-top: auto;
}

/* Enhanced visual cues and color contrast */
.amount-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
}

.income-badge {
    background-color: rgba(16, 185, 129, 0.15);
    color: var(--positive-color);
}

.expense-badge {
    background-color: rgba(220, 53, 69, 0.12);
    color: #d9534f;
}

.indicator-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.indicator-dot.positive {
    background-color: var(--positive-color);
}

.indicator-dot.negative {
    background-color: #d9534f;
}

.indicator-dot.warning {
    background-color: var(--warning-color);
}

.summary-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background-color: rgba(67, 97, 238, 0.1);
    border-radius: 50%;
    margin-right: 1rem;
}

.summary-icon i {
    color: var(--primary-color);
    font-size: 1.2rem;
}

/* Card body enhancements */
.dashboard-card-link {
    display: block;
    color: inherit;
    text-decoration: none;
    height: 100%;
}

.dashboard-card-link .card-body {
    height: 100%;
    padding: 1.25rem;
    border-radius: 0 0 12px 12px;
    transition: all 0.3s ease;
}

.dashboard-card-link:hover .card-body {
    background-color: rgba(248, 249, 250, 0.7);
    cursor: pointer;
}

/* Enhanced widget content styling */
.dashboard-grid .progress {
    height: 8px;
    border-radius: 4px;
    margin-bottom: 1rem;
    background-color: rgba(0, 0, 0, 0.05);
    overflow: hidden;
}

.dashboard-grid .progress-bar {
    background: linear-gradient(to right, var(--primary-color), var(--primary-light));
    border-radius: 4px;
}

.dashboard-grid .chart-container {
    margin: 0.5rem 0;
}

.dashboard-grid .card-body {
    padding: 1.25rem;
}

.dashboard-elements-container {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.5rem;
    min-height: 50px;
    margin-bottom: 0.5rem;
}

.dashboard-element {
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    cursor: grab;
    transition: all 0.2s ease;
    user-select: none;
    position: relative;
}

.dashboard-element:last-child {
    margin-bottom: 0;
}

.dashboard-element:hover {
    background-color: #e9ecef;
    transform: translateY(-2px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.dashboard-element:active {
    cursor: grabbing;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    transform: scale(1.02);
    background-color: #e2e6ea;
    z-index: 10;
}

.dashboard-element.sortable-ghost {
    opacity: 0.4;
    background-color: #c8e6c9;
}

.dashboard-element.sortable-chosen {
    background-color: #e3f2fd;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    z-index: 10;
}

.dashboard-element.sortable-drag {
    opacity: 0.8;
    transform: rotate(1deg);
}

.dashboard-element-icon {
    color: #6c757d;
    font-size: 1.1rem;
    margin-right: 0.75rem;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f1f8fe;
    border-radius: 50%;
}

.section-title {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

/* Improved total balance styling */
.total-amount {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.5px;
    padding: 0.25rem 0.4rem;
    border-radius: 6px;
    display: inline-block;
}

/* Enhanced transaction list styling */
.transaction-item {
    padding: 0.6rem 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

/* Fixed height for recent transactions card */
[data-element-id="recent-transactions"] .card-body {
    min-height: 220px;
    display: flex;
    flex-direction: column;
}

.transaction-item:last-child {
    border-bottom: none;
}

.transaction-date {
    color: var(--text-secondary);
    font-size: 0.8rem;
    margin-top: 0.2rem;
}

/* Transaction category styling */
.transaction-category {
    display: inline-flex;
    align-items: center;
    background: linear-gradient(to right, rgba(67, 97, 238, 0.1), rgba(67, 97, 238, 0.05));
    border-radius: 12px;
    padding: 0.2rem 0.6rem;
    margin-left: 0.4rem;
    font-size: 0.75rem;
    font-weight: 500;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    transition: all 0.2s ease;
    color: var(--text-primary);
    position: relative;
    overflow: hidden;
}

/* Color-coded category badges based on type */
.transaction-category[data-category-type="food"] {
    background: linear-gradient(to right, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
    color: #047857;
}

.transaction-category[data-category-type="bills"] {
    background: linear-gradient(to right, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
    color: #1e40af;
}

.transaction-category[data-category-type="transport"] {
    background: linear-gradient(to right, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
    color: #92400e;
}

.transaction-category[data-category-type="entertainment"] {
    background: linear-gradient(to right, rgba(139, 92, 246, 0.15), rgba(139, 92, 246, 0.05));
    color: #6d28d9;
}

.transaction-category[data-category-type="health"] {
    background: linear-gradient(to right, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05));
    color: #b91c1c;
}

.transaction-category[data-category-type="shopping"] {
    background: linear-gradient(to right, rgba(236, 72, 153, 0.15), rgba(236, 72, 153, 0.05));
    color: #be185d;
}

.transaction-category[data-category-type="income"] {
    background: linear-gradient(to right, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05));
    color: #047857;
}

.transaction-category[data-category-type="other"] {
    background: linear-gradient(to right, rgba(107, 114, 128, 0.15), rgba(107, 114, 128, 0.05));
    color: #4b5563;
}

/* Special handling for expense and income types */
.transaction-category[data-category-type="expense"] {
    background: linear-gradient(to right, rgba(220, 53, 69, 0.15), rgba(220, 53, 69, 0.05));
    color: #b91c1c;
}

.transaction-category[data-category-type="expense"]::before {
    content: "\\F295"; /* bi-bag-dash */
}

/* Small category icons */
.transaction-category::before {
    content: "\\F29F"; /* Default icon: bi-bookmark */
    font-family: "bootstrap-icons";
    margin-right: 0.35rem;
    font-size: 0.75rem;
    display: inline-block;
}

.transaction-category[data-category-type="food"]::before {
    content: "\\F29B"; /* bi-basket */
}

.transaction-category[data-category-type="bills"]::before {
    content: "\\F491"; /* bi-receipt */
}

.transaction-category[data-category-type="transport"]::before {
    content: "\\F6BC"; /* bi-car-front */
}

.transaction-category[data-category-type="entertainment"]::before {
    content: "\\F587"; /* bi-tv */
}

.transaction-category[data-category-type="health"]::before {
    content: "\\F48A"; /* bi-heart-pulse */
}

.transaction-category[data-category-type="shopping"]::before {
    content: "\\F23F"; /* bi-bag */
}

.transaction-category[data-category-type="income"]::before {
    content: "\\F555"; /* bi-piggy-bank */
}

.transaction-category[data-category-type="other"]::before {
    content: "\\F533"; /* bi-three-dots */
}

/* Dark mode adjustments for category badges */
body.dark-mode .transaction-category {
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

body.dark-mode .transaction-category[data-category-type="food"] {
    background: linear-gradient(to right, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
    color: #34d399;
}

body.dark-mode .transaction-category[data-category-type="bills"] {
    background: linear-gradient(to right, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
    color: #60a5fa;
}

body.dark-mode .transaction-category[data-category-type="transport"] {
    background: linear-gradient(to right, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
    color: #fbbf24;
}

body.dark-mode .transaction-category[data-category-type="entertainment"] {
    background: linear-gradient(to right, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
    color: #a78bfa;
}

body.dark-mode .transaction-category[data-category-type="health"] {
    background: linear-gradient(to right, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
    color: #f87171;
}

body.dark-mode .transaction-category[data-category-type="shopping"] {
    background: linear-gradient(to right, rgba(236, 72, 153, 0.2), rgba(236, 72, 153, 0.1));
    color: #ec4899;
}

body.dark-mode .transaction-category[data-category-type="income"] {
    background: linear-gradient(to right, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
    color: #34d399;
}

body.dark-mode .transaction-category[data-category-type="other"] {
    background: linear-gradient(to right, rgba(107, 114, 128, 0.2), rgba(107, 114, 128, 0.1));
    color: #9ca3af;
}

/* Chart enhancements */
.chart-label {
    font-size: 0.85rem;
    color: var(--text-primary);
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.chart-container {
    position: relative;
}

.chart-value-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    pointer-events: none;
}

.chart-value-display .value {
    font-size: 1rem;
    font-weight: bold;
    line-height: 1;
}

.chart-value-display .label {
    font-size: 0.7rem;
    color: var(--text-secondary);
}

/* Custom chart tooltip styling */
.custom-chart-tooltip {
    position: absolute;
    padding: 8px 12px;
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    border-radius: 6px;
    pointer-events: none;
    z-index: 1000;
    font-size: 0.85rem;
    max-width: 200px;
    white-space: nowrap;
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: opacity 0.15s ease;
    opacity: 0;
}

.custom-chart-tooltip.visible {
    opacity: 1;
}

.custom-chart-tooltip-item {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
}

.custom-chart-tooltip-item:last-child {
    margin-bottom: 0;
}

.custom-chart-tooltip-color {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
}

.custom-chart-tooltip-label {
    margin-right: 8px;
    font-weight: 600;
}

.custom-chart-tooltip-value {
    font-weight: 500;
}

@media (prefers-color-scheme: dark) {
    .dashboard-grid .card:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        background-color: rgba(255, 255, 255, 0.03);
    }
    
    .dashboard-card-link:hover .card-body {
        background-color: rgba(255, 255, 255, 0.02) !important;
    }

    .custom-chart-tooltip {
        background: rgba(30, 30, 30, 0.95);
        color: rgba(255, 255, 255, 0.95);
        border-color: rgba(255, 255, 255, 0.1);
    }
}
</style>
{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<header class="d-flex justify-content-between align-items-center mb-4">
    <div class="welcome-container d-flex align-items-center">
        <div class="welcome-icon me-3">
            <i class="bi bi-calendar-check text-primary" style="font-size: 1.75rem;"></i>
        </div>
    <div>
            <p class="h5 mb-1 welcome-text">Welcome back, {{ user.username }}!</p>
            <p class="text-muted small mb-0 date-text">Today is {% now "l, F j, Y" %}</p>
        </div>
    </div>
</header>

<div class="row g-3">
    <!-- Account Balances -->
    <div class="col-md-4 d-flex">
        <a href="{% url 'accounts_list' %}" class="text-decoration-none flex-fill">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-3 d-flex flex-column">
                    <div class="d-flex align-items-center mb-3">
                        <div class="summary-icon">
                            <i class="bi bi-bank"></i>
                        </div>
                        <h6 class="card-title mb-0">Summary</h6>
                    </div>
                    <div class="flex-grow-1 d-flex flex-column">
                        {% if accounts_summary.debit.accounts|length == 0 and accounts_summary.credit.accounts|length == 0 and accounts_summary.wallet.accounts|length == 0 %}
                            <div class="text-center text-muted py-4">
                                No existing accounts yet.
                            </div>
                        {% else %}
                            <div class="card-section">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="account-type-label">
                                        <span class="indicator-dot {% if accounts_summary.debit.balance >= 0 %}positive{% else %}negative{% endif %}"></span>
                                        Debit Balance ({{ accounts_summary.debit.accounts|length }} account/s)
                                    </span>
                                    <span class="amount-badge ms-2 {% if accounts_summary.debit.balance >= 0 %}income-badge{% else %}expense-badge{% endif %}">
                                        ₱{{ accounts_summary.debit.balance|floatformat:2 }}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="account-type-label">
                                        <span class="indicator-dot {% if accounts_summary.wallet.balance >= 0 %}positive{% else %}negative{% endif %}"></span>
                                        Wallet Balance ({{ accounts_summary.wallet.accounts|length }} account/s)
                                    </span>
                                    <span class="amount-badge ms-2 {% if accounts_summary.wallet.balance >= 0 %}income-badge{% else %}expense-badge{% endif %}">
                                        ₱{{ accounts_summary.wallet.balance|floatformat:2 }}
                                    </span>
                                </div>
                            </div>
                            <div class="card-footer-section">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-medium">Available Balance</span>
                                    <span class="total-amount ms-2 {% if accounts_summary.debit.balance|add:accounts_summary.wallet.balance >= 0 %}income-text{% else %}expense-text{% endif %}">
                                        ₱{{ accounts_summary.debit.balance|add:accounts_summary.wallet.balance|floatformat:2 }}
                                    </span>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </a>
    </div>

    <!-- Current Month Summary -->
    <div class="col-md-4 d-flex">
        <a href="{% url 'transactions' %}?month={{ current_month|date:'Y-m' }}" class="text-decoration-none flex-fill">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-3 d-flex flex-column">
                        <div class="d-flex align-items-center mb-3">
                        <div class="summary-icon">
                            <i class="bi bi-calendar-month"></i>
                        </div>
                        <h6 class="card-title mb-0">This Month</h6>
                    </div>
                    <div class="flex-grow-1 d-flex flex-column">
                        <div class="d-flex align-items-center card-section">
                            <div class="chart-container me-3" style="width: 110px; height: 110px; position: relative;">
                                <canvas id="currentMonthChart"></canvas>
                            </div>
                            <div class="flex-grow-1 py-2 px-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="value-label">
                                        <span class="indicator-dot positive"></span>Income
                                    </span>
                                    <span class="amount-badge income-badge">
                                        ₱{{ current_month_income|floatformat:2 }}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="value-label">
                                        <span class="indicator-dot negative"></span>Expenses
                                    </span>
                                    <span class="amount-badge expense-badge">
                                        ₱{{ current_month_expenses|floatformat:2 }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer-section">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-medium">Net</span>
                                <span class="total-amount ms-2 {% if current_month_balance >= 0 %}income-text{% else %}expense-text{% endif %}">
                                    ₱{{ current_month_balance|floatformat:2 }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <!-- Previous Month Summary -->
    <div class="col-md-4 d-flex">
        <a href="{% url 'transactions' %}?month={{ prev_month|date:'Y-m' }}" class="text-decoration-none flex-fill">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-3 d-flex flex-column">
                    <div class="d-flex align-items-center mb-3">
                        <div class="summary-icon">
                            <i class="bi bi-calendar-range"></i>
                        </div>
                        <h6 class="card-title mb-0">Last Month</h6>
                    </div>
                    <div class="flex-grow-1 d-flex flex-column">
                        <div class="d-flex justify-items-center align-items-center card-section">
                            <div class="chart-container me-3" style="width: 110px; height: 110px; position: relative;">
                                <canvas id="prevMonthChart"></canvas>
                            </div>
                            <div class="flex-grow-1 py-2 px-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="value-label">
                                        <span class="indicator-dot positive"></span>Income
                                    </span>
                                    <span class="amount-badge income-badge">
                                        ₱{{ prev_month_income|floatformat:2 }}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="value-label">
                                        <span class="indicator-dot negative"></span>Expenses
                                    </span>
                                    <span class="amount-badge expense-badge">
                                        ₱{{ prev_month_expenses|floatformat:2 }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer-section">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-medium">Net</span>
                                <span class="total-amount ms-2 {% if prev_month_balance >= 0 %}income-text{% else %}expense-text{% endif %}">
                                    ₱{{ prev_month_balance|floatformat:2 }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Rest of the dashboard content -->
{% if budget_warnings %}
<section class="budget-warnings mt-5" aria-labelledby="warnings-heading">
    <div class="card border-0 shadow-sm">
        <header class="card-header bg-warning text-dark d-flex align-items-center">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <h2 class="h6 mb-0" id="warnings-heading">Budget Warnings</h2>
        </header>
        <div class="card-body p-3">
            {% for warning in budget_warnings %}
            <div class="d-flex justify-content-between align-items-center {% if not forloop.last %}mb-3{% endif %}">
                <div>
                    <div class="fw-bold mb-1">{{ warning.category }}</div>
                    <div class="value-label">
                        Spent ₱{{ warning.spent|floatformat:2 }} of ₱{{ warning.budget|floatformat:2 }}
                    </div>
                </div>
                <div class="text-end ms-3">
                    <div class="total-amount {% if warning.percentage >= 100 %}text-danger{% else %}text-warning{% endif %}">
                        {{ warning.percentage }}%
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Customizable Dashboard -->
<section class="customizable-dashboard mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h5 mb-0 d-flex align-items-center">
            <i class="bi bi-grid-3x3-gap-fill me-2 text-primary"></i>
            Widgets
        </h2>
        <button type="button" class="btn btn-sm btn-outline-primary px-3 py-2" data-bs-toggle="modal" data-bs-target="#dashboardPreferencesModal">
            <i class="bi bi-grid"></i> Customize Widgets
        </button>
    </div>
    
    <div id="dashboard-grid" class="dashboard-grid row g-4">
        <!-- Dashboard widgets will be loaded here via JavaScript -->
    </div>
</section>

<!-- Dashboard Preferences Modal -->
<div class="modal fade" id="dashboardPreferencesModal" tabindex="-1" aria-labelledby="dashboardPreferencesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dashboardPreferencesModalLabel">WIDGET PREFERENCES</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="columns-select" class="form-label">Number of widget columns to display:</label>
                    <select id="columns-select" class="form-select">
                        <option value="1">1 (Full width)</option>
                        <option value="2" selected>2 (Medium width)</option>
                        <option value="3">3 (Small width)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <h6 class="section-title">Visible elements</h6>
                    <div id="visible-elements" class="dashboard-elements-container">
                        <div class="dashboard-element" data-element-id="budgets">
                            <div class="dashboard-element-icon">
                                <i class="bi bi-pie-chart"></i>
                            </div>
                            <span>Budgets</span>
                        </div>
                        <div class="dashboard-element" data-element-id="chart-balance">
                            <div class="dashboard-element-icon">
                                <i class="bi bi-graph-up"></i>
                            </div>
                            <span>Chart: Balance</span>
                        </div>
                        <div class="dashboard-element" data-element-id="chart-last-7-days">
                            <div class="dashboard-element-icon">
                                <i class="bi bi-bar-chart"></i>
                            </div>
                            <span>Chart: Last 7 days</span>
                        </div>
                        <div class="dashboard-element" data-element-id="recent-transactions">
                            <div class="dashboard-element-icon">
                                <i class="bi bi-list-check"></i>
                            </div>
                            <span>Recent Transactions</span>
                        </div>
                    </div>
                    <small class="text-muted mt-1 d-block"><i class="bi bi-info-circle"></i> Drag elements to reorder or move between sections</small>
                </div>

                <div class="mb-3">
                    <h6 class="section-title">Hidden elements</h6>
                    <div id="hidden-elements" class="dashboard-elements-container">
                        <div class="dashboard-element" data-element-id="debts-credits">
                            <div class="dashboard-element-icon">
                                <i class="bi bi-credit-card"></i>
                            </div>
                            <span>Debts / Credits</span>
                        </div>
                        <div class="dashboard-element" data-element-id="scheduled-transactions">
                            <div class="dashboard-element-icon">
                                <i class="bi bi-calendar-event"></i>
                            </div>
                            <span>Scheduled transactions: This month</span>
                        </div>
                        <div class="dashboard-element" data-element-id="cash-flow">
                            <div class="dashboard-element-icon">
                                <i class="bi bi-cash-coin"></i>
                            </div>
                            <span>Cash flow (Transactions)</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">CANCEL</button>
                <button type="button" class="btn btn-primary" id="save-dashboard-preferences">SAVE</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Pass Django template variables to JavaScript cleanly
const dashboardData = {
    currentMonth: {
        income: {% if current_month_income %}{{ current_month_income }}{% else %}0{% endif %},
        expenses: {% if current_month_expenses %}{{ current_month_expenses }}{% else %}0{% endif %}
    },
    prevMonth: {
        income: {% if prev_month_income %}{{ prev_month_income }}{% else %}0{% endif %},
        expenses: {% if prev_month_expenses %}{{ prev_month_expenses }}{% else %}0{% endif %}
    }
};

document.addEventListener('DOMContentLoaded', function() {
    const chartConfig = {
        type: 'doughnut',
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: true,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ₱' + context.raw.toFixed(2);
                        }
                    }
                }
            },
            events: ['mousemove', 'mouseout', 'click', 'touchstart', 'touchmove']
        }
    };

    // Create custom tooltip container
    const tooltipContainer = document.createElement('div');
    tooltipContainer.className = 'custom-chart-tooltip';
    document.body.appendChild(tooltipContainer);

    // Current Month Chart
    const currentMonthCtx = document.getElementById('currentMonthChart').getContext('2d');
    const currentMonthIncome = dashboardData.currentMonth.income;
    const currentMonthExpenses = dashboardData.currentMonth.expenses;
    let currentMonthData, currentMonthColors, currentMonthBorders, currentMonthLabels;

    const noData = currentMonthIncome == 0 && currentMonthExpenses == 0;
    
    if (noData) {
        currentMonthData = [1, 0];
        currentMonthColors = ['rgba(108, 117, 125, 0.8)', 'rgba(108, 117, 125, 0.8)'];
        currentMonthBorders = ['rgb(108, 117, 125)', 'rgb(108, 117, 125)'];
        currentMonthLabels = ['No Data', ''];
    } else {
        currentMonthData = [currentMonthIncome, currentMonthExpenses];
        currentMonthColors = ['rgba(40, 167, 69, 0.8)', 'rgba(220, 53, 69, 0.8)'];
        currentMonthBorders = ['rgb(40, 167, 69)', 'rgb(220, 53, 69)'];
        currentMonthLabels = ['Income', 'Expenses'];
    }

    let currentMonthChart = new Chart(currentMonthCtx, {
        type: 'doughnut',
        data: {
            labels: currentMonthLabels,
            datasets: [{
                data: currentMonthData,
                backgroundColor: currentMonthColors,
                borderColor: currentMonthBorders,
                borderWidth: 0,
                hoverOffset: noData ? 0 : 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            layout: {
                padding: {
                    top: 20,
                    bottom: 20,
                    left: 20,
                    right: 20
                }
            },
            events: noData ? [] : ['mousemove', 'mouseout', 'click', 'touchstart', 'touchmove'],
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false,
                    external: function(context) {
                        // Skip tooltip for no data
                        if (noData) {
                            return;
                        }
                        
                        // Tooltip Element
                        const {chart, tooltip} = context;
                        
                        // Hide if no tooltip
                        if (tooltip.opacity === 0) {
                            tooltipContainer.classList.remove('visible');
                            return;
                        }
                        
                        // Set Text
                        if (tooltip.body) {
                            const titleLines = tooltip.title || [];
                            const bodyLines = tooltip.body.map(b => b.lines);
                            
                            // Calculate positioning
                            const {offsetLeft: positionX, offsetTop: positionY} = chart.canvas;
                            
                            // Display, position, and set styles for font
                            tooltipContainer.classList.add('visible');
                            
                            let innerHtml = '';
                            
                            // Get the correct data index from the tooltip
                            const dataIndex = tooltip.dataPoints[0].dataIndex;
                            const colors = tooltip.labelColors[0];
                            const colorStyle = `background-color: ${colors.backgroundColor}`;
                            
                            innerHtml += `<div class="custom-chart-tooltip-item">
                                <span class="custom-chart-tooltip-color" style="${colorStyle}"></span>
                                <span class="custom-chart-tooltip-label">${titleLines[0] || ''}</span>
                                <span class="custom-chart-tooltip-value">₱${parseFloat(currentMonthData[dataIndex]).toFixed(2)}</span>
                            </div>`;
                            
                            tooltipContainer.innerHTML = innerHtml;
                            
                            // Position tooltip correctly
                            const canvasRect = chart.canvas.getBoundingClientRect();
                            const tooltipRect = tooltipContainer.getBoundingClientRect();
                            let left = canvasRect.left + window.scrollX + tooltip.caretX - (tooltipRect.width / 2);
                            let top = canvasRect.top + window.scrollY + tooltip.caretY - tooltipRect.height - 10;
                            
                            // Ensure tooltip doesn't go offscreen
                            const windowWidth = window.innerWidth;
                            if (left + tooltipRect.width > windowWidth) {
                                left = windowWidth - tooltipRect.width - 10;
                            }
                            if (left < 0) {
                                left = 10;
                            }
                            
                            if (top < window.scrollY) {
                                top = canvasRect.top + window.scrollY + tooltip.caretY + 10;
                            }
                            
                            tooltipContainer.style.left = left + 'px';
                            tooltipContainer.style.top = top + 'px';
                        }
                    }
                }
            }
        }
    });

    // Previous Month Chart
    const prevMonthCtx = document.getElementById('prevMonthChart').getContext('2d');
    const prevMonthIncome = dashboardData.prevMonth.income;
    const prevMonthExpenses = dashboardData.prevMonth.expenses;
    let prevMonthData, prevMonthColors, prevMonthBorders, prevMonthLabels;

    const prevNoData = prevMonthIncome == 0 && prevMonthExpenses == 0;
    
    if (prevNoData) {
        prevMonthData = [1, 0];
        prevMonthColors = ['rgba(108, 117, 125, 0.8)', 'rgba(108, 117, 125, 0.8)'];
        prevMonthBorders = ['rgb(108, 117, 125)', 'rgb(108, 117, 125)'];
        prevMonthLabels = ['No Data', ''];
    } else {
        prevMonthData = [prevMonthIncome, prevMonthExpenses];
        prevMonthColors = ['rgba(40, 167, 69, 0.8)', 'rgba(220, 53, 69, 0.8)'];
        prevMonthBorders = ['rgb(40, 167, 69)', 'rgb(220, 53, 69)'];
        prevMonthLabels = ['Income', 'Expenses'];
    }

    let prevMonthChart = new Chart(prevMonthCtx, {
        type: 'doughnut',
        data: {
            labels: prevMonthLabels,
            datasets: [{
                data: prevMonthData,
                backgroundColor: prevMonthColors,
                borderColor: prevMonthBorders,
                borderWidth: 0,
                hoverOffset: prevNoData ? 0 : 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            layout: {
                padding: {
                    top: 20,
                    bottom: 20,
                    left: 20,
                    right: 20
                }
            },
            events: prevNoData ? [] : ['mousemove', 'mouseout', 'click', 'touchstart', 'touchmove'],
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false,
                    external: function(context) {
                        // Skip tooltip for no data
                        if (prevNoData) {
                            return;
                        }
                        
                        // Tooltip Element
                        const {chart, tooltip} = context;
                        
                        // Hide if no tooltip
                        if (tooltip.opacity === 0) {
                            tooltipContainer.classList.remove('visible');
                            return;
                        }
                        
                        // Set Text
                        if (tooltip.body) {
                            const titleLines = tooltip.title || [];
                            const bodyLines = tooltip.body.map(b => b.lines);
                            
                            // Calculate positioning
                            const {offsetLeft: positionX, offsetTop: positionY} = chart.canvas;
                            
                            // Display, position, and set styles for font
                            tooltipContainer.classList.add('visible');
                            
                            let innerHtml = '';
                            
                            // Get the correct data index from the tooltip
                            const dataIndex = tooltip.dataPoints[0].dataIndex;
                            const colors = tooltip.labelColors[0];
                            const colorStyle = `background-color: ${colors.backgroundColor}`;
                            
                            innerHtml += `<div class="custom-chart-tooltip-item">
                                <span class="custom-chart-tooltip-color" style="${colorStyle}"></span>
                                <span class="custom-chart-tooltip-label">${titleLines[0] || ''}</span>
                                <span class="custom-chart-tooltip-value">₱${parseFloat(prevMonthData[dataIndex]).toFixed(2)}</span>
                            </div>`;
                            
                            tooltipContainer.innerHTML = innerHtml;
                            
                            // Position tooltip correctly
                            const canvasRect = chart.canvas.getBoundingClientRect();
                            const tooltipRect = tooltipContainer.getBoundingClientRect();
                            let left = canvasRect.left + window.scrollX + tooltip.caretX - (tooltipRect.width / 2);
                            let top = canvasRect.top + window.scrollY + tooltip.caretY - tooltipRect.height - 10;
                            
                            // Ensure tooltip doesn't go offscreen
                            const windowWidth = window.innerWidth;
                            if (left + tooltipRect.width > windowWidth) {
                                left = windowWidth - tooltipRect.width - 10;
                            }
                            if (left < 0) {
                                left = 10;
                            }
                            
                            if (top < window.scrollY) {
                                top = canvasRect.top + window.scrollY + tooltip.caretY + 10;
                            }
                            
                            tooltipContainer.style.left = left + 'px';
                            tooltipContainer.style.top = top + 'px';
                        }
                    }
                }
            }
        }
    });

    // Hide tooltip when moving away from charts
    document.addEventListener('mousemove', function(e) {
        const chartElements = document.querySelectorAll('canvas');
        let isOverChart = false;
        
        chartElements.forEach(chart => {
            const rect = chart.getBoundingClientRect();
            if (
                e.clientX >= rect.left &&
                e.clientX <= rect.right &&
                e.clientY >= rect.top &&
                e.clientY <= rect.bottom
            ) {
                isOverChart = true;
            }
        });
        
        if (!isOverChart) {
            tooltipContainer.classList.remove('visible');
        }
    });

    // Dashboard customization code
    initDashboard();
});

// Dashboard drag and drop functionality
function initDashboard() {
    // Define all available widgets and their content
    const widgetDefinitions = {
        'budgets': {
            title: 'Budgets',
            content: `
                <a href="{% url 'manage_budget' %}" class="dashboard-card-link">
                    <div class="card-body p-3">
                        <div class="mb-2">
                            <div class="mb-1">Groceries</div>
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar" role="progressbar" style="width: 65%;" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <div class="mb-1">Utilities</div>
                            <div class="progress mb-2" style="height: 6px;">
                                <div class="progress-bar" role="progressbar" style="width: 45%;" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                </a>
            `
        },
        'chart-balance': {
            title: 'Chart: Balance Trend',
            content: `
                <div class="card-body p-3">
                    <div class="chart-container" style="height: 150px;">
                        <canvas id="balanceChart"></canvas>
                    </div>
                </div>
            `,
            initScript: function() {
                if (document.getElementById('balanceChart')) {
                    const ctx = document.getElementById('balanceChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Balance',
                                data: [5000, 5500, 4800, 5200, 5800, 6100],
                                borderColor: 'rgba(75, 192, 192, 1)',
                                tension: 0.1,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            }
        },
        'chart-last-7-days': {
            title: 'Chart: Last 7 Days',
            content: `
                <div class="card-body p-3">
                    <div class="chart-container" style="height: 150px;">
                        <canvas id="last7DaysChart"></canvas>
                    </div>
                </div>
            `,
            initScript: function() {
                if (document.getElementById('last7DaysChart')) {
                    const ctx = document.getElementById('last7DaysChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                            datasets: [{
                                label: 'Income',
                                data: [50, 20, 80, 30, 0, 100, 45],
                                backgroundColor: 'rgba(40, 167, 69, 0.8)'
                            }, {
                                label: 'Expenses',
                                data: [30, 45, 25, 70, 55, 90, 40],
                                backgroundColor: 'rgba(220, 53, 69, 0.8)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            }
                        }
                    });
                }
            }
        },
        'debts-credits': {
            title: 'Debts / Credits',
            content: `
                <div class="card-body p-3">
                    <div class="mb-2">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Student Loan</span>
                            <span class="fw-bold expense-text">₱12,500.00</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Car Loan</span>
                            <span class="fw-bold expense-text">₱8,750.00</span>
                        </div>
                    </div>
                    <a href="#" class="btn btn-sm btn-outline-primary mt-2">View All</a>
                </div>
            `
        },
        'scheduled-transactions': {
            title: 'Upcoming Transactions',
            content: `
                <a href="{% url 'scheduled_transactions' %}" class="dashboard-card-link">
                    <div class="card-body p-3">
                        <div class="mb-2">
                            <div class="d-flex justify-content-between mb-1">
                                <div>
                                    <span>Rent</span>
                                    <div class="small text-muted">May 1, 2023</div>
                                </div>
                                <span class="fw-bold expense-text">₱1,200.00</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <div>
                                    <span>Internet Bill</span>
                                    <div class="small text-muted">May 5, 2023</div>
                                </div>
                                <span class="fw-bold expense-text">₱65.00</span>
                            </div>
                        </div>
                    </div>
                </a>
            `
        },
        'cash-flow': {
            title: 'Cash Flow',
            content: `
                <div class="card-body p-3">
                    <h6 class="mb-3">Cash Flow</h6>
                    <div class="chart-container" style="height: 150px;">
                        <canvas id="cashFlowChart"></canvas>
                    </div>
                </div>
            `,
            initScript: function() {
                if (document.getElementById('cashFlowChart')) {
                    const ctx = document.getElementById('cashFlowChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Income',
                                data: [4500, 4200, 4800, 5000, 5200, 5500],
                                backgroundColor: 'rgba(40, 167, 69, 0.8)'
                            }, {
                                label: 'Expenses',
                                data: [4000, 3800, 4500, 4200, 4600, 4900],
                                backgroundColor: 'rgba(220, 53, 69, 0.8)'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            }
                        }
                    });
                }
            }
        },
        'recent-transactions': {
            title: 'Recent Transactions',
            content: `
                <a href="{% url 'transactions' %}" class="dashboard-card-link">
                    <div class="card-body p-3">
                        {% if recent_transactions %}
                            {% for transaction in recent_transactions|slice:":3" %}
                            <div class="transaction-item d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ transaction.title }}</strong>
                                    <div class="transaction-date">
                                        {{ transaction.date|date:"M d, Y" }}
                                        {% if transaction.category %}
                                        <span class="transaction-category" data-category-type="{{ transaction.category.type|default:transaction.type|default:'other' }}">
                                            {{ transaction.category.name }}
                                        </span>
                                        {% elif transaction.type %}
                                        <span class="transaction-category" data-category-type="{{ transaction.type }}">
                                            {{ transaction.type|title }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <span class="amount-badge ms-2 {% if transaction.type == 'income' %}income-badge{% else %}expense-badge{% endif %}">
                                    {% if transaction.type == 'expense' %}-{% endif %}₱{{ transaction.amount|floatformat:2 }}
                                </span>
                            </div>
                            {% endfor %}
                            {% if recent_transactions|length > 3 %}
                            <div class="text-center mt-2">
                                <small class="text-muted">View all {{ recent_transactions|length }} transactions</small>
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="text-muted">No recent transactions.</div>
                        {% endif %}
                    </div>
                </a>
            `
        }
    };

    // Initialize dashboard preferences from Django template variables
    const prefsData = {
        columns: {% if dashboard_preferences.columns %}{{ dashboard_preferences.columns }}{% else %}2{% endif %},
        visibleElements: {% if dashboard_preferences.visible_elements %}{{ dashboard_preferences.visible_elements|safe }}{% else %}["budgets", "chart-balance", "chart-last-7-days", "recent-transactions"]{% endif %},
        hiddenElements: {% if dashboard_preferences.hidden_elements %}{{ dashboard_preferences.hidden_elements|safe }}{% else %}["debts-credits", "scheduled-transactions", "cash-flow"]{% endif %}
    };
    
    let dashboardPreferences = prefsData;

    // Initialize dashboard
    renderDashboard();

    // Initialize drag and drop in the modal with enhanced options
    let visibleSortable = new Sortable(document.getElementById('visible-elements'), {
        group: 'dashboard-elements',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        onEnd: updateElementsOrder
    });

    let hiddenSortable = new Sortable(document.getElementById('hidden-elements'), {
        group: 'dashboard-elements',
        animation: 150,
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        onEnd: updateElementsOrder
    });

    let dashboardSortable = new Sortable(document.getElementById('dashboard-grid'), {
        animation: 150,
        handle: '.card-header',
        ghostClass: 'sortable-ghost',
        chosenClass: 'sortable-chosen',
        dragClass: 'sortable-drag',
        onEnd: updateDashboardOrder
    });

    // Handle column change
    document.getElementById('columns-select').addEventListener('change', function() {
        const columns = parseInt(this.value);
        updateDashboardColumns(columns);
        dashboardPreferences.columns = columns;
    });

    // Handle save button
    document.getElementById('save-dashboard-preferences').addEventListener('click', function() {
        // Update preferences based on current DOM state
        const visibleElements = Array.from(document.getElementById('visible-elements').children)
            .map(el => el.dataset.elementId);
        
        const hiddenElements = Array.from(document.getElementById('hidden-elements').children)
            .map(el => el.dataset.elementId);

        dashboardPreferences.visibleElements = visibleElements;
        dashboardPreferences.hiddenElements = hiddenElements;

        // Save to server
        saveDashboardPreferences(dashboardPreferences);

        // Re-render dashboard
        renderDashboard();

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('dashboardPreferencesModal'));
        modal.hide();
    });

    function saveDashboardPreferences(preferences) {
        // Save preferences to server
        fetch('{% url "save_dashboard_preferences" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                columns: preferences.columns,
                visibleElements: preferences.visibleElements,
                hiddenElements: preferences.hiddenElements
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('Dashboard preferences saved successfully');
            } else {
                console.error('Error saving dashboard preferences:', data.message);
            }
        })
        .catch(error => {
            console.error('Error saving dashboard preferences:', error);
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateElementsOrder() {
        // This will be called after drag and drop events between visible and hidden elements
        // We don't save changes until the user clicks Save
    }

    function updateDashboardOrder() {
        // This will update the order of widgets in the dashboard after drag and drop
        // Save to server immediately
        const elements = Array.from(document.getElementById('dashboard-grid').children)
            .map(el => el.dataset.elementId);
        
        dashboardPreferences.visibleElements = elements;
        saveDashboardPreferences(dashboardPreferences);
    }

    function updateDashboardColumns(columns) {
        // Remove existing column classes
        const dashboardGrid = document.getElementById('dashboard-grid');
        dashboardGrid.classList.remove('row-cols-1', 'row-cols-2', 'row-cols-3');
        
        // Add appropriate column class
        dashboardGrid.classList.add(`row-cols-${columns}`);
    }

    function renderDashboard() {
        const dashboardGrid = document.getElementById('dashboard-grid');
        dashboardGrid.innerHTML = '';

        // Add columns class
        updateDashboardColumns(dashboardPreferences.columns);

        // Add widgets based on visibleElements preference
        dashboardPreferences.visibleElements.forEach(elementId => {
            if (widgetDefinitions[elementId]) {
                const widget = widgetDefinitions[elementId];
                const widgetElement = document.createElement('div');
                widgetElement.className = 'col';
                widgetElement.dataset.elementId = elementId;
                
                widgetElement.innerHTML = `
                    <div class="card border-0 shadow-sm dashboard-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fs-6">${widget.title}</h5>
                            <i class="bi bi-grip-horizontal"></i>
                        </div>
                        ${widget.content}
                    </div>
                `;
                
                dashboardGrid.appendChild(widgetElement);
                
                // Initialize any charts or other components if needed
                if (widget.initScript) {
                    widget.initScript();
                }
            }
        });
    }
}
</script>
{% endblock %}